<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Aventurero v7.7 (SPA)</title>
    <style>
        /* ==========================================================================
           1. IMPORTACI√ìN DE FUENTES E INICIALIZACI√ìN
           ========================================================================== */
        
        /* Importamos la fuente estilo "pixel art" desde Google Fonts para darle la tem√°tica de videojuego retro. */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        /* Reglas para el elemento ra√≠z de la p√°gina (la etiqueta <html>). */
        html {
            /* Establece el tama√±o de fuente base al 100% del navegador (usualmente 16px).
               Esto nos permite usar unidades relativas 'rem' de forma predecible. */
            font-size: 100%; 
            /* Habilita un efecto de desplazamiento suave al navegar por anclas o con JavaScript. */
            scroll-behavior: smooth;
        }

        /* ==========================================================================
           2. ESTILOS GENERALES DEL CUERPO (BODY)
           ========================================================================== */
        
        body {
            background-color: #1e1e2f;  /* Fondo oscuro para la tem√°tica de fantas√≠a/ne√≥n. */
            color: #dcdcdc;             /* Color de texto principal (un gris claro) para buena legibilidad. */
            font-family: 'Press Start 2P', cursive; /* Establece la fuente retro para toda la app. */
            display: flex;              /* Usa Flexbox para centrar el contenido principal. */
            justify-content: center;    /* Centra el contenido horizontalmente. */
            align-items: flex-start;    /* Alinea el contenido en la parte superior. */
            padding: 20px;              /* A√±ade un espacio de aire alrededor de toda la p√°gina. */
        }

        /* ==========================================================================
           3. ESTRUCTURA Y LAYOUT PRINCIPAL
           ========================================================================== */

        /* Contenedor principal que envuelve la barra lateral y el contenido. */
        .main-container {
            width: 100%;                /* Ocupa todo el ancho disponible. */
            max-width: 1200px;          /* Pero con un l√≠mite para no estirarse demasiado en pantallas grandes. */
            display: flex;              /* Pone la barra lateral y el contenido principal uno al lado del otro. */
            gap: 20px;                  /* Crea un espacio de 20px entre la barra lateral y el contenido. */
            align-items: flex-start;    /* Alinea ambos elementos en la parte superior. */
        }

        /* Barra lateral (Sidebar) que contiene la navegaci√≥n y los paneles de estado. */
        .sidebar {
            width: 280px;               /* Ancho fijo para la barra lateral. */
            flex-shrink: 0;             /* Evita que la barra se encoja si no hay espacio. */
            position: sticky;           /* La barra lateral se quedar√° "pegada" al hacer scroll. */
            top: 20px;                  /* Se pega a 20px del borde superior de la pantalla. */
        }

        /* Contenedor para el contenido principal a la derecha. */
        .main-content {
            flex-grow: 1;               /* Permite que esta secci√≥n crezca para ocupar el espacio restante. */
        }

        /* ==========================================================================
           4. ESTILOS DE LOS CONTENEDORES (PANELES)
           ========================================================================== */

        /* Estilo base para todos los paneles o "contenedores" con borde. */
        .container {
            border: 3px solid #4f4f6f;      /* Borde grueso y oscuro. */
            background-color: #2a2a40;      /* Fondo ligeramente m√°s claro que el body. */
            padding: 20px;                  /* Espacio interno para que el contenido no toque los bordes. */
            width: 100%;                    /* Ocupa todo el ancho de su padre (sidebar o main-content). */
            box-shadow: 0 4px 12px rgba(0,0,0,0.5); /* Sombra para dar profundidad. */
            border-radius: 8px;             /* Esquinas redondeadas. */
            margin-bottom: 20px;            /* Espacio por debajo de cada panel. */
            box-sizing: border-box;         /* Asegura que el padding y borde no aumenten el ancho total. */
        }

        /* ==========================================================================
           5. TIPOGRAF√çA (T√çTULOS Y TEXTOS)
           ========================================================================== */

        /* T√≠tulos principales (H1) y secundarios (H2). */
        h1, h2 {
            color: #ffdd57;             /* Color amarillo dorado para los t√≠tulos. */
            text-align: center;         /* Texto centrado. */
            border-bottom: 2px solid #4f4f6f; /* L√≠nea decorativa inferior. */
            padding-bottom: 10px;       /* Espacio entre el texto y la l√≠nea. */
            margin-top: 0;              /* Elimina el margen superior por defecto. */
            font-size: 1.5rem;          /* Tama√±o de fuente relativo al 'html'. 1.5 veces el tama√±o base. */
            text-shadow: 2px 2px #c23616; /* Sombra de texto para un efecto 3D/retro. */
        }

        h2 { font-size: 1.2rem; } /* H2 un poco m√°s peque√±o que H1. */
        h3 { font-size: 1rem; color: #4a90e2; margin-top: 20px; } /* H3 para t√≠tulos de categor√≠a. */
        h4 { font-size: 0.8rem; color: #a0a0c0; margin-bottom: 10px; border-top: 1px solid #4f4f6f; padding-top: 15px; margin-top: 15px;} /* H4 para subsecciones. */

        /* Etiquetas de los campos de formulario. */
        label {
            display: block;             /* Hace que la etiqueta ocupe su propia l√≠nea. */
            margin-bottom: 8px;         /* Espacio debajo de la etiqueta. */
            color: #a0a0c0;             /* Color gris√°ceo. */
            font-size: 0.8rem;          /* Tama√±o de fuente m√°s peque√±o. */
        }

        /* ==========================================================================
           6. ELEMENTOS DE FORMULARIO (INPUTS, SELECTS, BOTONES)
           ========================================================================== */

        /* Estilo para los men√∫s desplegables (select) y campos de entrada (input). */
        select, input[type="number"], input[type="text"] {
            width: 100%;                /* Ocupan todo el ancho de su contenedor. */
            padding: 12px;              /* Espacio interno para mayor comodidad. */
            margin-bottom: 15px;        /* Espacio por debajo. */
            background-color: #1e1e2f;  /* Fondo oscuro. */
            color: #dcdcdc;             /* Texto claro. */
            border: 2px solid #4f4f6f;  /* Borde oscuro. */
            border-radius: 4px;         /* Esquinas ligeramente redondeadas. */
            font-family: inherit;       /* Usa la misma fuente 'Press Start 2P' del body. */
            font-size: 0.9rem;          /* Tama√±o de fuente. */
            box-sizing: border-box;     /* Evita que el padding/borde afecte el ancho total. */
        }

        /* Estilo base para todos los botones. */
        button, .nav-btn {
            width: 100%;                /* Ocupan todo el ancho. */
            padding: 12px;              /* Espacio interno. */
            margin-bottom: 10px;        /* Espacio por debajo. */
            color: #000000;                /* Texto negro. */
            font-weight: bold;          /* Texto en negrita. */
            cursor: pointer;            /* Muestra una mano al pasar el cursor. */
            border: none;               /* Sin borde por defecto. */
            border-radius: 4px;         /* Esquinas redondeadas. */
            font-family: inherit;       /* Hereda la fuente retro. */
            text-align: center;         /* Texto centrado. */
            transition: all 0.1s ease-in-out; /* Animaci√≥n suave para cualquier cambio. */
            display: block;             /* Ocupa su propia l√≠nea. */
        }
        
        /* Bot√≥n principal para registrar XP. */
        #register-btn { background: linear-gradient(145deg, #4a90e2, #3a7ac8); border-bottom: 4px solid #2a5a9a; }
        
        /* Botones de Google Drive. */
        .gdrive-btn { background-color: #4CAF50; border-bottom: 4px solid #388E3C; }
        
        /* Botones de navegaci√≥n de la barra lateral. */
        .nav-btn { background-color: #6a4f9a; border-bottom: 4px solid #4a2f7a; }
        
        /* Estilo para el bot√≥n de navegaci√≥n que est√° activo. */
        .nav-btn.active { background-color: #8a6fba; transform: translateY(2px); border-bottom-width: 2px;}
        
        /* Estilo para botones desactivados. */
        button:disabled { background-color: #555; border-bottom-color: #444; color: #888; cursor: not-allowed; }

        /* ==========================================================================
           7. PANELES ESPEC√çFICOS Y LISTAS
           ========================================================================== */

        /* Lista de habilidades y lista de registro (log). */
        .skills-panel ul, .log-panel ul {
            list-style: none;           /* Quita los puntos de la lista. */
            padding: 0;                 /* Quita el espacio de relleno por defecto. */
            max-height: 450px;          /* Altura m√°xima antes de que aparezca el scroll. */
            overflow-y: auto;           /* Muestra una barra de scroll vertical si el contenido excede la altura. */
        }
        
        /* Cada elemento (<li>) de la lista de habilidades. */
        .skills-panel li {
            background-color: #33334f;
            padding: 10px 15px;
            margin-bottom: 6px;
            border-left: 5px solid #ffdd57; /* Borde izquierdo dorado decorativo. */
            display: flex;
            justify-content: space-between; /* Coloca el texto y la barra de progreso en extremos opuestos. */
            align-items: center;
            font-size: 0.8rem;
            border-radius: 4px;
        }
        
        /* Estilos para la p√°gina de "Descripci√≥n". */
        .description-item {
            display: flex; flex-direction: column; align-items: flex-start; gap: 15px;
            background-color: #33334f; padding: 15px; margin-bottom: 10px;
            border-left: 5px solid #ffdd57; border-radius: 4px;
            font-size: 0.75rem; line-height: 1.5;
        }
        .description-header { display: flex; align-items: center; gap: 15px; width: 100%;}
        .description-img { width: 80px; height: 80px; border-radius: 4px; flex-shrink: 0; }
        
        /* Contenedor de sub-habilidades en la p√°gina de descripci√≥n. */
        .subskill-container { width: 100%; }
        .subskill-list { list-style: none; padding: 0; }
        .subskill-list li { 
            display: flex; 
            align-items: center; 
            background-color: #2a2a40; 
            padding: 8px; 
            border-radius: 3px; 
            margin-bottom: 5px; 
            font-size: 0.9rem;
            gap: 10px;
        }
        .subskill-input-group { display: flex; gap: 10px; } /* Grupo para a√±adir sub-habilidad. */
        
        /* Bot√≥n para borrar una sub-habilidad. */
        .delete-subskill-btn { 
            background: #c23616; border: none; color: white; padding: 5px 8px;
            border-radius: 3px; cursor: pointer; font-family: inherit; font-size: 0.8rem;
            width: auto;            /* Ancho se ajusta al contenido. */
            margin-left: auto;      /* Se alinea a la derecha. */
            flex-shrink: 0;         /* No se encoge. */
        }
        
        /* Bot√≥n "+" para a√±adir una sub-habilidad. */
        .add-subskill-btn { flex-shrink: 0; width: auto; padding: 0 15px; font-size: 1.2rem; background-color: #4CAF50; border-bottom: 4px solid #388E3C; }
        
        .skill-icon { margin-right: 10px; } /* Espacio para el √≠cono de la habilidad. */
        .log-panel ul { max-height: 200px; } /* Altura m√°xima para el panel de registro. */
        
        /* Estilo para los mensajes de subida de nivel. */
        .level-up { color: #32ff7e; font-weight: bold; text-align: center; font-size: 0.8rem !important; border-left-color: #32ff7e !important; }
        
        /* Mensaje de estado de Google Drive. */
        #gdrive-status { text-align: center; font-size: 0.7rem; padding: 10px; color: #a0a0c0; min-height: 20px; }
        
        /* Barra de progreso de XP. */
        .progress-bar-bg { background-color: #1e1e2f; border-radius: 5px; height: 10px; width: 100px; border: 1px solid #4f4f6f; }
        .progress-bar-fg { background-color: #32ff7e; height: 100%; border-radius: 5px; }
        
        /* Control de visibilidad de las p√°ginas SPA. */
        .page-content { display: none; } /* Por defecto, todas las p√°ginas est√°n ocultas. */
        .page-content.active { display: block; } /* La p√°gina con la clase 'active' se muestra. */
        
        /* Texto de informaci√≥n de la versi√≥n. */
        #version-info {
            font-size: 0.65rem; color: #8a8a9e; text-align: right;
            margin-top: 15px; padding-top: 10px;
            border-top: 1px solid #4f4f6f; line-height: 1.4;
        }
        
        /* ==========================================================================
           8. DISE√ëO RESPONSIVO (PARA M√ìVILES)
           ========================================================================== */

        /* Estas reglas se aplican solo si el ancho de la pantalla es 800px o menos. */
        @media (max-width: 800px) {
            /* Coloca la barra lateral encima del contenido principal. */
            .main-container { flex-direction: column; }
            /* La barra lateral ahora ocupa todo el ancho y no es "pegajosa". */
            .sidebar { width: 100%; position: static; }
            /* En la p√°gina de descripci√≥n, la imagen se pone encima del texto. */
            .description-header { flex-direction: column; text-align: center; }

            /* Aumenta el tama√±o de la fuente base en un 10% para mejorar la legibilidad en m√≥viles. */
            html {
                font-size: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- ESTRUCTURA HTML PRINCIPAL -->

    <!-- Contenedor general que envuelve toda la aplicaci√≥n. -->
    <div class="main-container">
        
        <!-- INICIO DE LA BARRA LATERAL (SIDEBAR) -->
        <div class="sidebar">
            
            <!-- Panel de Navegaci√≥n -->
            <div class="container">
                <h2>Navegaci√≥n</h2>
                <button class="nav-btn active" data-page="entrenamiento">Entrenamiento</button>
                <button class="nav-btn" data-page="misiones">Misiones</button>
                <button class="nav-btn" data-page="descripcion">Descripci√≥n</button>
            </div>
            
            <!-- Panel de Sincronizaci√≥n con Google Drive -->
            <div class="container gdrive-section">
                <div id="gdrive-status">Inicia sesi√≥n para sincronizar.</div>
                <button id="auth-btn">Iniciar Sesi√≥n con Google</button>
                <button id="save-drive-btn" class="gdrive-btn" disabled>Guardar datos</button>
                <button id="load-drive-btn" class="gdrive-btn" disabled>Cargar el poder</button>
            </div>

            <!-- Panel de Registro de Actividad (Log) -->
             <div class="container log-panel">
                <h2>Registro</h2>
                <ul id="log-list"></ul>
                <div id="version-info">
                    v7.7 (Corregido el inicio de sesi√≥n de Google)
                </div>
            </div>
        </div>
        <!-- FIN DE LA BARRA LATERAL -->

        <!-- INICIO DEL CONTENIDO PRINCIPAL -->
        <div class="main-content">
            
            <!-- P√°gina/Secci√≥n de Entrenamiento (visible por defecto) -->
            <div id="page-entrenamiento" class="page-content active">
                <!-- Panel para registrar XP -->
                <div class="container">
                    <h1>Panel de Aventurero</h1>
                    <div class="input-section">
                        <label for="skill-select">Habilidad General:</label>
                        <select id="skill-select"></select>
                        
                        <label for="subskill-select">Habilidad Concreta:</label>
                        <select id="subskill-select"></select>

                        <label for="time-input">Minutos de pr√°ctica:</label>
                        <input type="number" id="time-input" min="1" placeholder="Ej: 30">
                        <button id="register-btn">Registrar XP</button>
                    </div>
                </div>
                <!-- Panel para mostrar la lista de habilidades y su progreso -->
                <div class="container skills-panel">
                    <h2>Habilidades</h2>
                    <ul id="skills-list"></ul>
                </div>
            </div>

            <!-- P√°gina/Secci√≥n de Misiones (oculta por defecto) -->
            <div id="page-misiones" class="page-content">
                <div class="container">
                    <h1>Misiones</h1>
                    <p style="text-align:center;">¬°Aqu√≠ podr√°s ver y gestionar tus misiones!</p>
                    <p style="text-align:center; color: #a0a0c0;">(Pr√≥ximamente...)</p>
                </div>
            </div>

            <!-- P√°gina/Secci√≥n de Descripci√≥n (oculta por defecto) -->
            <div id="page-descripcion" class="page-content">
                <div class="container description-content">
                    <!-- El contenido de esta secci√≥n se genera din√°micamente con JavaScript. -->
                </div>
            </div>
        </div>
        <!-- FIN DEL CONTENIDO PRINCIPAL -->
    </div>

    <script>
    //================================================================================//
    //  SECCI√ìN 1: CONFIGURACI√ìN DE ACCESO A GOOGLE DRIVE API                         //
    //  Estas son las "llaves" que permiten a nuestra app conectarse con Google.    //
    //  CLIENT_ID identifica nuestra aplicaci√≥n.                                      //
    //  API_KEY autoriza el uso de la API de Google Drive.                            //
    //================================================================================//
    const CLIENT_ID = '432634777489-acq7bb59h2ggc223oafccitlvskvqh6p.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyB17ehizwOK9efPy7Bo7Zss2zveYSVhwE8';
    
    //================================================================================//
    //  SECCI√ìN 2: ESTRUCTURA DE DATOS INICIAL                                        //
    //  Este es el "molde" o plantilla para todas las habilidades del juego.          //
    //  Cuando la app se inicia por primera vez o se resetea, usa esta estructura.    //
    //  Define el nombre, icono, descripci√≥n, etc., de cada habilidad.                //
    //================================================================================//
    const initialSkills = {
        'Avance (Formaci√≥n)': { xp: 0, level: 1, icon: '‚öîÔ∏è', subSkills: [], img: 'https://placehold.co/80x80/c23616/FFFFFF?text=‚öîÔ∏è', category: 'combate', description: 'Todo lo que impulsa tu carrera. Estudiar, hacer networking, desarrollar un proyecto laboral, buscar un ascenso, trabajar en equipo, puntualidad.' },
        'Fuerza (Salud centrada en el cuerpo)': { xp: 0, level: 1, icon: 'üí™', subSkills: [], img: 'https://placehold.co/80x80/e84118/FFFFFF?text=üí™', category: 'combate', description: 'Entrenamiento de fuerza, levantamiento de pesas, calistenia, funcional.' },
        'Defensa (Finanzas Personales)': { xp: 0, level: 1, icon: 'üõ°Ô∏è', subSkills: [], img: 'https://placehold.co/80x80/4cd137/FFFFFF?text=üõ°Ô∏è', category: 'combate', description: 'Ahorrar, invertir, crear un presupuesto, aprender sobre econom√≠a, pagar deudas.' },
        'Constituci√≥n (Salud y Resistencia)': { xp: 0, level: 1, icon: '‚ù§Ô∏è', subSkills: [], img: 'https://placehold.co/80x80/ff4757/FFFFFF?text=‚ù§Ô∏è', category: 'combate', description: 'Dormir bien, mantenerse hidratado, procurar cumplir con los ciclos circadianos, chequeos m√©dicos, ba√±os de agua helada.' },
        'Agilidad (Salud centrada en cuerpo)': { xp: 0, level: 1, icon: 'üèÉ', subSkills: [], img: 'https://placehold.co/80x80/1e90ff/FFFFFF?text=üèÉ', category: 'combate', description: 'Actividades de Cardio y Flexibilidad como correr, nadar, yoga, ciclismo, estiramientos, gimnasia funcional.' },
        'Magia (Habilidades Sociales)': { xp: 0, level: 1, icon: '‚ú®', subSkills: [], img: 'https://placehold.co/80x80/8c7ae6/FFFFFF?text=‚ú®', category: 'combate', description: 'Comunicaci√≥n, oratoria, negociaci√≥n, empat√≠a, inteligencia emocional, psicoterapia, compa√±erismo' },
        'Espiritual (Salud Mental)': { xp: 0, level: 1, icon: 'üßò', subSkills: [], img: 'https://placehold.co/80x80/718093/FFFFFF?text=üßò', category: 'autocuidado', description: 'Meditar, Mindfulness, escribir un diario, practicar la gratitud, terapias, plegarias, amor, amistades' },
        'Nutrici√≥n (Salud corporal)': { xp: 0, level: 1, icon: 'üåø', subSkills: [], img: 'https://placehold.co/80x80/27ae60/FFFFFF?text=üåø', category: 'autocuidado', description: 'Aprender sobre macronutrientes, planificar comidas saludables, reducir procesados.' },
        'Cocina (Pr√°ctica)': { xp: 0, level: 1, icon: 'üç≥', subSkills: [], img: 'https://placehold.co/80x80/fbc531/FFFFFF?text=üç≥', category: 'autocuidado', description: 'Preparar tus propias comidas, aprender nuevas recetas, batch cooking.' },
        'Hobbies y Relajaci√≥n (en la Nada y en el Todo a la vez)': { xp: 0, level: 1, icon: 'üåå', subSkills: [], img: 'https://placehold.co/80x80/3498db/FFFFFF?text=üåå', category: 'autocuidado', description: 'Dedicar tiempo a pasatiempos que te relajen y disfrutes sin un fin productivo. Leer ficci√≥n, tocar un instrumento, pintar, pescar.' },
        'Estudio Profundo': { xp: 0, level: 1, icon: 'üìö', subSkills: [], img: 'https://placehold.co/80x80/9b59b6/FFFFFF?text=üìö', category: 'artesania', description: 'Aprender una habilidad "dura" y compleja. Programaci√≥n, un nuevo idioma, carpinter√≠a, edici√≥n de video.' },
        'Creaci√≥n (Proyectos Creativos)': { xp: 0, level: 1, icon: 'üé®', subSkills: [], img: 'https://placehold.co/80x80/e74c3c/FFFFFF?text=üé®', category: 'artesania', description: 'Escribir, dibujar, componer m√∫sica, crear contenido para tus seres queridos o las redes.' },
        'Construcci√≥n (Organizaci√≥n)': { xp: 0, level: 1, icon: 'üè°', subSkills: [], img: 'https://placehold.co/80x80/f39c12/FFFFFF?text=üè°', category: 'artesania', description: 'Ordenar tu casa, optimizar tu espacio de trabajo, bricolaje (DIY), minimalismo.'},
        'Grabaci√≥n de Fuego (Disciplina)': { xp: 0, level: 1, icon: 'üî•', subSkills: [], img: 'https://placehold.co/80x80/d35400/FFFFFF?text=üî•', category: 'artesania', description: 'La habilidad "meta". Se enfoca en el acto de construir y mantener la rutina. La clave es la simplicidad y la consistencia.' }
    };
    
    //================================================================================//
    //  SECCI√ìN 3: MAPA DE MIGRACI√ìN DE DATOS                                         //
    //  Esto sirve para actualizar datos de versiones antiguas. Si un usuario        //
    //  carga un archivo guardado con un nombre de habilidad viejo (ej: "Ataque"),    //
    //  este mapa lo convierte al nombre nuevo (ej: "Avance") sin perder el XP.      //
    //================================================================================//
    const MIGRATION_MAP = {
        "Ataque (Carrera)": "Avance (Formaci√≥n)",
        "Fuerza (Fitness)": "Fuerza (Salud centrada en el cuerpo)",
        "Agilidad (Cardio)": "Agilidad (Salud centrada en cuerpo)",
        "Oraci√≥n (Mindfulness)": "Espiritual (Salud Mental)",
        "Herbolog√≠a (Nutrici√≥n)": "Nutrici√≥n (Salud corporal)",
        "Pesca (Hobbies)": "Hobbies y Relajaci√≥n",
        "Herrer√≠a (Estudio)": "Estudio Profundo",
        "Creaci√≥n de Fuego (Disciplina y H√°bitos)": "Grabaci√≥n de Fuego (Disciplina)",
        "Hobbies y Relajaci√≥n": "Hobbies y Relajaci√≥n (en la Nada y en el Todo a la vez)"
    };

    // Variable global que contendr√° el estado actual de las habilidades del usuario.
    let skills = {};
    
    //================================================================================//
    //  SECCI√ìN 4: REFERENCIAS A ELEMENTOS DEL HTML (DOM)                             //
    //  Aqu√≠ "guardamos" en variables de JavaScript los elementos importantes de la   //
    //  p√°gina (botones, listas, inputs) para poder manipularlos f√°cilmente.          //
    //================================================================================//
    const authBtn = document.getElementById('auth-btn');
    const saveBtn = document.getElementById('save-drive-btn');
    const loadBtn = document.getElementById('load-drive-btn');
    const statusDiv = document.getElementById('gdrive-status');
    const skillSelect = document.getElementById('skill-select');
    const subSkillSelect = document.getElementById('subskill-select');
    const timeInput = document.getElementById('time-input');
    const registerBtn = document.getElementById('register-btn');
    const skillsList = document.getElementById('skills-list');
    const logList = document.getElementById('log-list');
    const descriptionContainer = document.querySelector('#page-descripcion .description-content');
    
    //================================================================================//
    //  SECCI√ìN 5: L√ìGICA DE NAVEGACI√ìN (SPA - Single Page Application)               //
    //  Este c√≥digo hace que los botones "Entrenamiento", "Misiones" y                //
    //  "Descripci√≥n" muestren su contenido sin que la p√°gina web se recargue.        //
    //================================================================================//
    const navButtons = document.querySelectorAll('.nav-btn');
    const pages = document.querySelectorAll('.page-content');
    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            // 1. Obtiene el nombre de la p√°gina a mostrar desde el atributo 'data-page' del bot√≥n.
            const targetPage = button.getAttribute('data-page');
            
            // 2. Quita la clase 'active' de todos los botones y se la a√±ade solo al que fue pulsado.
            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // 3. Oculta todas las p√°ginas y muestra solo la que corresponde al bot√≥n pulsado.
            pages.forEach(page => {
                page.classList.toggle('active', page.id === 'page-' + targetPage);
            });

            // 4. Si la pantalla es peque√±a (m√≥vil), se desplaza autom√°ticamente hacia la secci√≥n de contenido.
            if (window.matchMedia('(max-width: 800px)').matches) {
                const targetElement = document.getElementById('page-' + targetPage);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        });
    });

    //================================================================================//
    //  SECCI√ìN 6: L√ìGICA DE LA P√ÅGINA "DESCRIPCI√ìN"                                  //
    //  Controla todo lo que pasa en la pesta√±a de descripci√≥n: muestra las           //
    //  habilidades, sus detalles y permite a√±adir o borrar "Habilidades Concretas".  //
    //================================================================================//
    
    // Construye y muestra todo el contenido de la p√°gina de descripci√≥n.
    function renderDescriptionPage() {
        descriptionContainer.innerHTML = ''; // Limpia el contenido anterior.
        const mainTitle = document.createElement('h1');
        mainTitle.textContent = 'Descripci√≥n de Habilidades';
        descriptionContainer.appendChild(mainTitle);

        const categories = {
            combate: 'Habilidades de "Combate" (Proactivas y de Afrontamiento)',
            autocuidado: 'Habilidades de "Autocuidado"',
            artesania: 'Habilidades de "Artesan√≠a" (Creaci√≥n y Conocimiento)'
        };

        // Recorre cada categor√≠a y crea su secci√≥n.
        for (const categoryId in categories) {
            const categoryTitle = document.createElement('h3');
            categoryTitle.textContent = categories[categoryId];
            descriptionContainer.appendChild(categoryTitle);
            
            const categoryList = document.createElement('ul');
            categoryList.style.padding = '0';

            // Recorre todas las habilidades y las a√±ade a la categor√≠a correspondiente.
            for (const skillName in skills) {
                if (skills[skillName].category === categoryId) {
                    const skill = skills[skillName];
                    const item = document.createElement('li');
                    item.className = 'description-item';
                    item.setAttribute('data-skill', skillName);
                    // Inserta el HTML para cada habilidad, incluyendo su imagen, descripci√≥n y el √°rea para sub-habilidades.
                    item.innerHTML = `
                        <div class="description-header">
                            <img src="${skill.img}" alt="Icono de ${skillName}" class="description-img">
                            <div><strong>${skillName}:</strong> ${skill.description}</div>
                        </div>
                        <div class="subskill-container">
                            <h4>Habilidades Concretas:</h4>
                            <ul class="subskill-list"></ul>
                            <div class="subskill-input-group">
                                <input type="text" placeholder="A√±adir nueva habilidad..." maxlength="50">
                                <button class="add-subskill-btn">+</button>
                            </div>
                        </div>`;
                    categoryList.appendChild(item);
                }
            }
            descriptionContainer.appendChild(categoryList);
        }
        renderAllSubSkillLists(); // Dibuja las listas de sub-habilidades.
        addDescriptionPageListeners(); // Activa los botones de a√±adir/borrar.
    }
    
    // Dibuja la lista de sub-habilidades para UNA habilidad espec√≠fica.
    function renderSubSkillList(skillName) {
        const listElement = document.querySelector(`.description-item[data-skill="${skillName}"] .subskill-list`);
        if (!listElement) return; // Si no encuentra el elemento, no hace nada.
        listElement.innerHTML = ''; // Limpia la lista actual.
        if (skills[skillName] && skills[skillName].subSkills) {
            skills[skillName].subSkills.forEach((subSkill, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${subSkill}</span> <button class="delete-subskill-btn" data-index="${index}">X</button>`;
                listElement.appendChild(li);
            });
        }
    }

    // Llama a la funci√≥n anterior para TODAS las habilidades.
    function renderAllSubSkillLists() {
        for (const skillName in skills) { renderSubSkillList(skillName); }
    }

    // Activa los listeners para los botones de a√±adir y borrar sub-habilidades.
    function addDescriptionPageListeners() {
        descriptionContainer.addEventListener('click', (e) => {
            const target = e.target; // El elemento exacto donde se hizo clic.
            const parentItem = target.closest('.description-item'); // Busca el contenedor de habilidad m√°s cercano.
            if (!parentItem) return;

            const skillName = parentItem.getAttribute('data-skill');
            
            // Si se pulsa el bot√≥n de A√ëADIR.
            if (target.classList.contains('add-subskill-btn')) {
                const input = parentItem.querySelector('input[type="text"]');
                const value = input.value.trim(); // Obtiene el texto y quita espacios en blanco.
                if (value && skills[skillName].subSkills.length < 25) { // Si hay texto y no se excede el l√≠mite...
                    skills[skillName].subSkills.push(value); // ...lo a√±ade a los datos.
                    renderSubSkillList(skillName); // Actualiza la lista visual.
                    populateSubSkillSelect(skillSelect.value); // Actualiza el men√∫ desplegable de la p√°gina principal.
                    input.value = ''; // Limpia el campo de texto.
                }
            }

            // Si se pulsa el bot√≥n de BORRAR.
            if (target.classList.contains('delete-subskill-btn')) {
                const index = parseInt(target.getAttribute('data-index'));
                skills[skillName].subSkills.splice(index, 1); // Elimina la sub-habilidad del array de datos.
                renderSubSkillList(skillName); // Actualiza la lista visual.
                populateSubSkillSelect(skillSelect.value); // Actualiza el men√∫ desplegable.
            }
        });
    }

    //================================================================================//
    //  SECCI√ìN 7: INICIALIZACI√ìN DE LA API DE GOOGLE                                 //
    //  Este bloque se encarga de cargar y preparar las herramientas de Google        //
    //  para que podamos usarlas (iniciar sesi√≥n, guardar/cargar archivos).           //
    //================================================================================//
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/drive.file'; // Define qu√© permisos pedimos (acceso a archivos creados por la app).
    const FILENAME = 'progreso_agenda.json'; // Nombre del archivo que se guardar√° en Drive.
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    
    function gapiLoaded() { gapi.load('client', initializeGapiClient); } // Cuando la librer√≠a principal de Google carga.
    async function initializeGapiClient() {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS, });
        gapiInited = true; maybeEnableButtons();
    }
    function gisLoaded() { // Cuando la librer√≠a de inicio de sesi√≥n carga.
        tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '', });
        gisInited = true; maybeEnableButtons();
    }
    function maybeEnableButtons() { if (gapiInited && gisInited) { authBtn.style.display = 'block'; } } // Activa el bot√≥n de login solo cuando ambas librer√≠as est√°n listas.
    
    // Gestiona el flujo de autenticaci√≥n.
    function handleAuthClick() {
        tokenClient.callback = async (resp) => { // Funci√≥n que se ejecuta tras el login.
            if (resp.error !== undefined) { throw (resp); }
            authBtn.textContent = 'Refrescar Sesi√≥n';
            saveBtn.disabled = false; loadBtn.disabled = false;
            statusDiv.textContent = '¬°Sesi√≥n iniciada! Listo para sincronizar.';
        };
        // Si el usuario no est√° logueado, pide consentimiento. Si ya lo est√°, refresca el token silenciosamente.
        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
            tokenClient.requestAccessToken({prompt: ''});
        }
    }
    
    // **CORRECCI√ìN**: A√±adido el event listener para el bot√≥n de autenticaci√≥n.
    authBtn.addEventListener('click', handleAuthClick);
    
    //================================================================================//
    //  SECCI√ìN 8: FUNCIONES PRINCIPALES DE GOOGLE DRIVE                              //
    //  Aqu√≠ est√° la magia para conectar con la nube. Estas funciones buscan el       //
    //  archivo de guardado, lo crean si no existe, guardan el progreso y lo cargan.  //
    //================================================================================//
    
    // Busca en Drive si ya existe un archivo con nuestro nombre.
    async function findFileId() {
        try {
            const response = await gapi.client.drive.files.list({ 'q': `name='${FILENAME}' and trashed=false`, 'fields': 'files(id, name)', 'spaces': 'drive' });
            return response.result.files && response.result.files.length > 0 ? response.result.files[0].id : null;
        } catch (err) { addLogEntry(`Error buscando archivo: ${err.message}`, 'level-up'); return null; }
    }

    // Se ejecuta al pulsar el bot√≥n "Guardar en Drive".
    saveBtn.onclick = async () => {
        statusDiv.textContent = 'Guardando en Google Drive...';
        const fileId = await findFileId();
        const fileContent = JSON.stringify(skills, null, 2); // Convierte nuestros datos a texto JSON.
        
        // El resto es la estructura compleja que necesita la API de Drive para subir/actualizar un archivo.
        const boundary = '-------314159265358979323846';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";
        let metadata, requestBody;

        if (fileId) { // Si el archivo ya existe, lo actualiza (PATCH).
            metadata = { 'mimeType': 'application/json' };
            requestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter + 'Content-Type: application/json\r\n\r\n' + fileContent + close_delim;
            const request = gapi.client.request({
                'path': `/upload/drive/v3/files/${fileId}`, 'method': 'PATCH', 'params': { 'uploadType': 'multipart' },
                'headers': { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' }, 'body': requestBody
            });
            request.execute(() => { statusDiv.textContent = '¬°Progreso guardado!'; addLogEntry('üíæ Progreso guardado en la nube.'); });
        } else { // Si no existe, lo crea (POST).
            metadata = { 'name': FILENAME, 'mimeType': 'application/json' };
            requestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter + 'Content-Type: application/json\r\n\r\n' + fileContent + close_delim;
            const createRequest = gapi.client.request({
                'path': '/upload/drive/v3/files', 'method': 'POST', 'params': { 'uploadType': 'multipart' },
                'headers': { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' }, 'body': requestBody
            });
            createRequest.execute(() => { statusDiv.textContent = '¬°Archivo creado y guardado!'; addLogEntry('üíæ Archivo de progreso creado.'); });
        }
    };
    
    // Se ejecuta al pulsar "Cargar desde Drive".
    loadBtn.onclick = async () => {
        statusDiv.textContent = 'Cargando desde Google Drive...';
        const fileId = await findFileId();
        if (!fileId) { statusDiv.textContent = 'No se encontr√≥ archivo de progreso.'; addLogEntry('‚ö†Ô∏è No se encontr√≥ archivo.', 'level-up'); return; }
        try {
            const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
            const loadedSkills = JSON.parse(response.body); // Convierte el texto del archivo a objeto JavaScript.
            
            if (loadedSkills && typeof loadedSkills === 'object') {
                // Proceso de hidrataci√≥n y migraci√≥n de datos.
                const hydratedSkills = JSON.parse(JSON.stringify(initialSkills));
                let migrationApplied = false;
                
                for (const savedSkillName in loadedSkills) {
                    let targetSkillName = savedSkillName;
                    // Busca si el nombre de la habilidad cargada necesita ser migrado a uno nuevo.
                    while (MIGRATION_MAP[targetSkillName]) {
                        targetSkillName = MIGRATION_MAP[targetSkillName];
                        migrationApplied = true;
                    }
                    // Si la habilidad existe en la plantilla actual, copia los datos (XP, sub-habilidades).
                    if (hydratedSkills[targetSkillName]) {
                        const savedData = loadedSkills[savedSkillName];
                        hydratedSkills[targetSkillName].xp += savedData.xp || 0;
                        hydratedSkills[targetSkillName].level = getLevelFromXp(hydratedSkills[targetSkillName].xp);
                        const combinedSubSkills = new Set([...hydratedSkills[targetSkillName].subSkills, ...(savedData.subSkills || [])]);
                        hydratedSkills[targetSkillName].subSkills = Array.from(combinedSubSkills);
                    }
                }
                
                skills = hydratedSkills; // Reemplaza los datos actuales con los cargados y migrados.
                
                // Actualiza toda la interfaz con los nuevos datos.
                updateDisplay(); 
                populateSelect(); 
                renderDescriptionPage();
                statusDiv.textContent = '¬°Progreso cargado desde Drive!'; 
                addLogEntry('üìÇ Progreso cargado.');
                if (migrationApplied) {
                    addLogEntry('‚ú® ¬°Datos migrados a la nueva versi√≥n! Guarda para actualizar el archivo.', 'level-up');
                }
            } else { throw new Error("Formato de datos inv√°lido en el archivo de Drive."); }
        } catch (err) { statusDiv.textContent = `Error al cargar: ${err.message}`; addLogEntry(`‚ùå Error al cargar: ${err.message}`, 'level-up'); }
    };

    //================================================================================//
    //  SECCI√ìN 9: L√ìGICA CENTRAL DE LA APLICACI√ìN (EL "MOTOR" DEL JUEGO)             //
    //  Este es el coraz√≥n del panel. Calcula los niveles, actualiza la lista de      //
    //  habilidades, rellena los men√∫s desplegables y gestiona el registro de XP.     //
    //================================================================================//
    const XP_PER_15_MINS = 100; // Constante: cu√°nta XP se gana por cada 15 minutos.
    
    // F√≥rmula matem√°tica para calcular el nivel basado en la XP total.
    function getLevelFromXp(xp) {
        let level = 1; 
        while (true) { 
            let xpForNextLevel = Math.pow(level, 2) * 1000; 
            if (xp < xpForNextLevel) return level; 
            level++; 
            if (level > 200) return 200; // L√≠mite para evitar bucles infinitos.
        }
    }

    // Dibuja y actualiza la lista de habilidades principal, incluyendo las barras de progreso.
    function updateDisplay() {
        skillsList.innerHTML = ''; 
        const sortedSkills = Object.entries(skills).sort(([,a],[,b]) => b.xp - a.xp); // Ordena las habilidades por XP.
        for (const [skillName, skill] of sortedSkills) {
            const li = document.createElement('li'); 
            const xpForCurrentLevel = skill.level > 1 ? Math.pow(skill.level - 1, 2) * 1000 : 0;
            const xpForNextLevel = Math.pow(skill.level, 2) * 1000; 
            const xpInCurrentLevel = skill.xp - xpForCurrentLevel;
            const xpNeededForLevel = xpForNextLevel - xpForCurrentLevel; 
            const progressPercentage = (xpInCurrentLevel / xpNeededForLevel) * 100;
            li.innerHTML = `<div style="flex-grow: 1;"><span><span class="skill-icon">${skill.icon || '‚ùî'}</span>${skillName}</span><div style="font-size: 0.8rem; color: #a0a0c0;">Lvl: ${skill.level} (${skill.xp.toLocaleString()} XP)</div></div><div class="progress-bar-bg"><div class="progress-bar-fg" style="width: ${progressPercentage}%;"></div></div>`;
            skillsList.appendChild(li);
        }
    }

    // Rellena el men√∫ desplegable de "Habilidad General".
    function populateSelect() {
        skillSelect.innerHTML = ''; 
        const skillNames = Object.keys(skills); 
        skillNames.sort(); // Ordena alfab√©ticamente.
        for (const skillName of skillNames) { 
            const option = document.createElement('option'); 
            option.value = skillName; 
            option.textContent = skillName; 
            skillSelect.appendChild(option); 
        }
        populateSubSkillSelect(skillSelect.value); // Rellena las sub-habilidades de la primera opci√≥n.
    }
    
    // Rellena el men√∫ de "Habilidad Concreta" basado en la general seleccionada.
    function populateSubSkillSelect(selectedSkill) {
        subSkillSelect.innerHTML = '';
        if (skills[selectedSkill] && skills[selectedSkill].subSkills && skills[selectedSkill].subSkills.length > 0) {
            skills[selectedSkill].subSkills.forEach(subSkill => {
                const option = document.createElement('option');
                option.value = subSkill;
                option.textContent = subSkill;
                subSkillSelect.appendChild(option);
            });
            subSkillSelect.disabled = false;
        } else { // Si no hay sub-habilidades, muestra un mensaje y lo deshabilita.
            const option = document.createElement('option');
            option.textContent = 'Sin habilidades concretas';
            option.disabled = true;
            subSkillSelect.appendChild(option);
            subSkillSelect.disabled = true;
        }
    }
    
    // Listener que se activa cuando el usuario cambia la Habilidad General.
    skillSelect.addEventListener('change', (e) => {
        populateSubSkillSelect(e.target.value);
    });

    // A√±ade una nueva l√≠nea de texto al panel de "Registro" en la barra lateral.
    function addLogEntry(message, type = '') {
        const logEntry = document.createElement('li'); 
        logEntry.textContent = message; 
        if (type) logEntry.classList.add(type); // A√±ade una clase especial (ej. 'level-up') si es necesario.
        logList.prepend(logEntry); // Lo a√±ade al principio de la lista.
        if (logList.children.length > 20) logList.removeChild(logList.lastChild); // Limita el log a 20 entradas.
    }

    //================================================================================//
    //  SECCI√ìN 10: EVENTO PRINCIPAL - REGISTRAR EXPERIENCIA (XP)                     //
    //  Esta es la acci√≥n que se dispara al pulsar el bot√≥n "Registrar XP".           //
    //  Toma los datos de los inputs, calcula el XP ganado y actualiza todo.          //
    //================================================================================//
    registerBtn.addEventListener('click', () => {
        const selectedSkill = skillSelect.value;
        const selectedSubSkill = subSkillSelect.value;
        const timeSpent = parseInt(timeInput.value);
        if (!selectedSkill || isNaN(timeSpent) || timeSpent <= 0) { addLogEntry('Entrada inv√°lida.', 'level-up'); return; }
        
        const xpGained = Math.floor((timeSpent / 15) * XP_PER_15_MINS);
        const skillData = skills[selectedSkill];
        const oldLevel = skillData.level;
        skillData.xp += xpGained;
        skillData.level = getLevelFromXp(skillData.xp);
        
        let logMessage = `+${xpGained.toLocaleString()} XP en ${skillData.icon} ${selectedSkill}`;
        if (selectedSubSkill && !subSkillSelect.disabled) {
            logMessage += ` (${selectedSubSkill})`;
        }
        logMessage += ` (${timeSpent} min).`;
        addLogEntry(logMessage);

        if (skillData.level > oldLevel) {
            addLogEntry(`¬°Nivel ${skillData.level} en ${selectedSkill}!`, 'level-up');
        }
        timeInput.value = '';
        updateDisplay();
    });
    
    //================================================================================//
    //  SECCI√ìN 11: INICIALIZACI√ìN PRINCIPAL DE LA APLICACI√ìN                         //
    //  Esto es lo primero que se ejecuta cuando la p√°gina ha cargado por completo.   //
    //  Prepara la aplicaci√≥n para que el usuario pueda empezar a usarla.             //
    //================================================================================//
    window.onload = () => { 
        skills = JSON.parse(JSON.stringify(initialSkills)); // Carga la estructura de datos inicial.
        populateSelect(); // Rellena los men√∫s desplegables.
        updateDisplay();  // Muestra la lista de habilidades.
        renderDescriptionPage(); // Construye la p√°gina de descripci√≥n (aunque est√© oculta).
        addLogEntry('¬°Bienvenido, aventurero!'); 
    };
    </script>
    
    <!-- Scripts de Google. Se cargan de forma as√≠ncrona para no bloquear la p√°gina. -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
