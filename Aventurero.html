<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Aventurero v7.3 (SPA)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body {
            background-color: #1e1e2f; color: #dcdcdc; font-family: 'Press+Start+2P', cursive;
            display: flex; justify-content: center; align-items: flex-start; padding: 20px;
        }
        .main-container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .sidebar {
            width: 280px;
            flex-shrink: 0;
            position: sticky;
            top: 20px;
        }
        .main-content {
            flex-grow: 1;
        }
        .container {
            border: 3px solid #4f4f6f; background-color: #2a2a40; padding: 20px;
            width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.5); border-radius: 8px; margin-bottom: 20px;
            box-sizing: border-box;
        }
        h1, h2 {
            color: #ffdd57; text-align: center; border-bottom: 2px solid #4f4f6f;
            padding-bottom: 10px; margin-top: 0; font-size: 1.5em; text-shadow: 2px 2px #c23616;
        }
        h2 { font-size: 1.2em; }
        h3 { font-size: 1em; color: #4a90e2; margin-top: 20px; }
        h4 { font-size: 0.8em; color: #a0a0c0; margin-bottom: 10px; border-top: 1px solid #4f4f6f; padding-top: 15px; margin-top: 15px;}
        label { display: block; margin-bottom: 8px; color: #a0a0c0; font-size: 0.8em; }
        select, input[type="number"], input[type="text"] {
            width: 100%; padding: 12px; margin-bottom: 15px; background-color: #1e1e2f;
            color: #dcdcdc; border: 2px solid #4f4f6f; border-radius: 4px;
            font-family: inherit; font-size: 0.9em; box-sizing: border-box;
        }
        button, .nav-btn {
            width: 100%; padding: 12px; margin-bottom: 10px; color: #fff; font-weight: bold;
            cursor: pointer; border: none; border-radius: 4px; font-family: inherit; text-align: center;
            transition: all 0.1s ease-in-out; display: block;
        }
        #register-btn { background: linear-gradient(145deg, #4a90e2, #3a7ac8); border-bottom: 4px solid #2a5a9a; }
        .gdrive-btn { background-color: #4CAF50; border-bottom: 4px solid #388E3C; }
        .nav-btn { background-color: #6a4f9a; border-bottom: 4px solid #4a2f7a; }
        .nav-btn.active { background-color: #8a6fba; transform: translateY(2px); border-bottom-width: 2px;}
        button:disabled { background-color: #555; border-bottom-color: #444; color: #888; cursor: not-allowed; }
        .skills-panel ul, .log-panel ul { list-style: none; padding: 0; max-height: 450px; overflow-y: auto; }
        .skills-panel li {
            background-color: #33334f; padding: 10px 15px; margin-bottom: 6px; border-left: 5px solid #ffdd57;
            display: flex; justify-content: space-between; align-items: center; font-size: 0.8em; border-radius: 4px;
        }
        .description-item {
            display: flex; flex-direction: column; align-items: flex-start; gap: 15px;
            background-color: #33334f; padding: 15px; margin-bottom: 10px;
            border-left: 5px solid #ffdd57; border-radius: 4px;
            font-size: 0.75em; line-height: 1.5;
        }
        .description-header { display: flex; align-items: center; gap: 15px; width: 100%;}
        .description-img { width: 80px; height: 80px; border-radius: 4px; flex-shrink: 0; }
        .subskill-container { width: 100%; }
        .subskill-list { list-style: none; padding: 0; }
        .subskill-list li { 
            display: flex; 
            align-items: center; 
            background-color: #2a2a40; 
            padding: 8px; 
            border-radius: 3px; 
            margin-bottom: 5px; 
            font-size: 0.9em;
            gap: 10px;
        }
        .subskill-input-group { display: flex; gap: 10px; }
        .delete-subskill-btn { 
            background: #c23616; 
            border: none; 
            color: white; 
            padding: 5px 8px; 
            border-radius: 3px; 
            cursor: pointer; 
            font-family: inherit; 
            font-size: 0.8em;
            width: auto;
            margin-left: auto;
            flex-shrink: 0;
        }
        .add-subskill-btn { flex-shrink: 0; width: auto; padding: 0 15px; font-size: 1.2em; background-color: #4CAF50; border-bottom: 4px solid #388E3C; }
        .skill-icon { margin-right: 10px; }
        .log-panel ul { max-height: 200px; }
        .level-up { color: #32ff7e; font-weight: bold; text-align: center; font-size: 0.8em !important; border-left-color: #32ff7e !important; }
        #gdrive-status { text-align: center; font-size: 0.7em; padding: 10px; color: #a0a0c0; min-height: 20px; }
        .progress-bar-bg { background-color: #1e1e2f; border-radius: 5px; height: 10px; width: 100px; border: 1px solid #4f4f6f; }
        .progress-bar-fg { background-color: #32ff7e; height: 100%; border-radius: 5px; }
        .page-content { display: none; }
        .page-content.active { display: block; }
        
        #version-info {
            font-size: 0.65em;
            color: #8a8a9e;
            text-align: right;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #4f4f6f;
            line-height: 1.4;
        }
        
        @media (max-width: 800px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100%; position: static; }
            .description-header { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="container">
                <h2>Navegación</h2>
                <button class="nav-btn active" data-page="entrenamiento">Entrenamiento</button>
                <button class="nav-btn" data-page="misiones">Misiones</button>
                <button class="nav-btn" data-page="descripcion">Descripción</button>
            </div>
            <div class="container gdrive-section">
                <div id="gdrive-status">Inicia sesión para sincronizar.</div>
                <button id="auth-btn">Iniciar Sesión con Google</button>
                <button id="save-drive-btn" class="gdrive-btn" disabled>Guardar en Drive</button>
                <button id="load-drive-btn" class="gdrive-btn" disabled>Cargar desde Drive</button>
            </div>
             <div class="container log-panel">
                <h2>Registro</h2>
                <ul id="log-list"></ul>
                <div id="version-info">
                    v7.3 (Añadidos comentarios explicativos en el código)
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Página de Entrenamiento -->
            <div id="page-entrenamiento" class="page-content active">
                <div class="container">
                    <h1>Panel de Aventurero</h1>
                    <div class="input-section">
                        <label for="skill-select">Habilidad General:</label>
                        <select id="skill-select"></select>
                        
                        <label for="subskill-select">Habilidad Concreta:</label>
                        <select id="subskill-select"></select>

                        <label for="time-input">Minutos de práctica:</label>
                        <input type="number" id="time-input" min="1" placeholder="Ej: 30">
                        <button id="register-btn">Registrar XP</button>
                    </div>
                </div>
                <div class="container skills-panel">
                    <h2>Habilidades</h2>
                    <ul id="skills-list"></ul>
                </div>
            </div>

            <!-- Página de Misiones -->
            <div id="page-misiones" class="page-content">
                <div class="container">
                    <h1>Misiones</h1>
                    <p style="text-align:center;">¡Aquí podrás ver y gestionar tus misiones!</p>
                    <p style="text-align:center; color: #a0a0c0;">(Próximamente...)</p>
                </div>
            </div>

            <!-- Página de Descripción de Habilidades -->
            <div id="page-descripcion" class="page-content">
                <div class="container description-content">
                    <!-- El contenido se generará dinámicamente con JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
    //================================================================================//
    //   SECCIÓN 1: CONFIGURACIÓN DE ACCESO A GOOGLE DRIVE API                      //
    //   Estas son las "llaves" que permiten a nuestra app conectarse con Google.   //
    //   CLIENT_ID identifica nuestra aplicación.                                   //
    //   API_KEY autoriza el uso de la API de Google Drive.                         //
    //================================================================================//
    const CLIENT_ID = '432634777489-acq7bb59h2ggc223oafccitlvskvqh6p.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyB17ehizwOK9efPy7Bo7Zss2zveYSVhwE8';
    
    //================================================================================//
    //   SECCIÓN 2: ESTRUCTURA DE DATOS INICIAL                                     //
    //   Este es el "molde" o plantilla para todas las habilidades del juego.       //
    //   Cuando la app se inicia por primera vez o se resetea, usa esta estructura. //
    //   Define el nombre, icono, descripción, etc., de cada habilidad.             //
    //================================================================================//
    const initialSkills = {
        'Avance (Formación)': { xp: 0, level: 1, icon: '⚔️', subSkills: [], img: 'https://placehold.co/80x80/c23616/FFFFFF?text=⚔️', category: 'combate', description: 'Todo lo que impulsa tu carrera. Estudiar, hacer networking, desarrollar un proyecto laboral, buscar un ascenso, trabajar en equipo, puntualidad.' },
        'Fuerza (Salud centrada en el cuerpo)': { xp: 0, level: 1, icon: '💪', subSkills: [], img: 'https://placehold.co/80x80/e84118/FFFFFF?text=💪', category: 'combate', description: 'Entrenamiento de fuerza, levantamiento de pesas, calistenia, funcional.' },
        'Defensa (Finanzas Personales)': { xp: 0, level: 1, icon: '🛡️', subSkills: [], img: 'https://placehold.co/80x80/4cd137/FFFFFF?text=🛡️', category: 'combate', description: 'Ahorrar, invertir, crear un presupuesto, aprender sobre economía, pagar deudas.' },
        'Constitución (Salud y Resistencia)': { xp: 0, level: 1, icon: '❤️', subSkills: [], img: 'https://placehold.co/80x80/ff4757/FFFFFF?text=❤️', category: 'combate', description: 'Dormir bien, mantenerse hidratado, procurar cumplir con los ciclos circadianos, chequeos médicos, baños de agua helada.' },
        'Agilidad (Salud centrada en cuerpo)': { xp: 0, level: 1, icon: '🏃', subSkills: [], img: 'https://placehold.co/80x80/1e90ff/FFFFFF?text=🏃', category: 'combate', description: 'Actividades de Cardio y Flexibilidad como correr, nadar, yoga, ciclismo, estiramientos, gimnasia funcional.' },
        'Magia (Habilidades Sociales)': { xp: 0, level: 1, icon: '✨', subSkills: [], img: 'https://placehold.co/80x80/8c7ae6/FFFFFF?text=✨', category: 'combate', description: 'Comunicación, oratoria, negociación, empatía, inteligencia emocional, psicoterapia.' },
        'Espiritual (Salud Mental)': { xp: 0, level: 1, icon: '🧘', subSkills: [], img: 'https://placehold.co/80x80/718093/FFFFFF?text=🧘', category: 'autocuidado', description: 'Meditar, Mindfulness, escribir un diario, practicar la gratitud, terapias, plegarias.' },
        'Nutrición (Salud corporal)': { xp: 0, level: 1, icon: '🌿', subSkills: [], img: 'https://placehold.co/80x80/27ae60/FFFFFF?text=🌿', category: 'autocuidado', description: 'Aprender sobre macronutrientes, planificar comidas saludables, reducir procesados.' },
        'Cocina (Práctica)': { xp: 0, level: 1, icon: '�', subSkills: [], img: 'https://placehold.co/80x80/fbc531/FFFFFF?text=🍳', category: 'autocuidado', description: 'Preparar tus propias comidas, aprender nuevas recetas, batch cooking.' },
        'Hobbies y Relajación (en la Nada y en el Todo a la vez)': { xp: 0, level: 1, icon: '🌌', subSkills: [], img: 'https://placehold.co/80x80/3498db/FFFFFF?text=🌌', category: 'autocuidado', description: 'Dedicar tiempo a pasatiempos que te relajen y disfrutes sin un fin productivo. Leer ficción, tocar un instrumento, pintar, pescar.' },
        'Estudio Profundo': { xp: 0, level: 1, icon: '📚', subSkills: [], img: 'https://placehold.co/80x80/9b59b6/FFFFFF?text=📚', category: 'artesania', description: 'Aprender una habilidad "dura" y compleja. Programación, un nuevo idioma, carpintería, edición de video.' },
        'Creación (Proyectos Creativos)': { xp: 0, level: 1, icon: '🎨', subSkills: [], img: 'https://placehold.co/80x80/e74c3c/FFFFFF?text=🎨', category: 'artesania', description: 'Escribir, dibujar, componer música, crear contenido para tus seres queridos o las redes.' },
        'Construcción (Organización)': { xp: 0, level: 1, icon: '🏡', subSkills: [], img: 'https://placehold.co/80x80/f39c12/FFFFFF?text=🏡', category: 'artesania', description: 'Ordenar tu casa, optimizar tu espacio de trabajo, bricolaje (DIY), minimalismo.'},
        'Grabación de Fuego (Disciplina)': { xp: 0, level: 1, icon: '🔥', subSkills: [], img: 'https://placehold.co/80x80/d35400/FFFFFF?text=🔥', category: 'artesania', description: 'La habilidad "meta". Se enfoca en el acto de construir y mantener la rutina. La clave es la simplicidad y la consistencia.' }
    };
    
    //================================================================================//
    //   SECCIÓN 3: MAPA DE MIGRACIÓN DE DATOS                                        //
    //   Esto sirve para actualizar datos de versiones antiguas. Si un usuario       //
    //   carga un archivo guardado con un nombre de habilidad viejo (ej: "Ataque"), //
    //   este mapa lo convierte al nombre nuevo (ej: "Avance") sin perder el XP.    //
    //================================================================================//
    const MIGRATION_MAP = {
        "Ataque (Carrera)": "Avance (Formación)",
        "Fuerza (Fitness)": "Fuerza (Salud centrada en el cuerpo)",
        "Agilidad (Cardio)": "Agilidad (Salud centrada en cuerpo)",
        "Oración (Mindfulness)": "Espiritual (Salud Mental)",
        "Herbología (Nutrición)": "Nutrición (Salud corporal)",
        "Pesca (Hobbies)": "Hobbies y Relajación",
        "Herrería (Estudio)": "Estudio Profundo",
        "Creación de Fuego (Disciplina y Hábitos)": "Grabación de Fuego (Disciplina)",
        "Hobbies y Relajación": "Hobbies y Relajación (en la Nada y en el Todo a la vez)"
    };

    let skills = {};
    
    //================================================================================//
    //   SECCIÓN 4: REFERENCIAS A ELEMENTOS DEL HTML (DOM)                            //
    //   Aquí "guardamos" en variables de JavaScript los elementos importantes de la  //
    //   página (botones, listas, inputs) para poder manipularlos fácilmente.        //
    //================================================================================//
    const authBtn = document.getElementById('auth-btn');
    const saveBtn = document.getElementById('save-drive-btn');
    const loadBtn = document.getElementById('load-drive-btn');
    const statusDiv = document.getElementById('gdrive-status');
    const skillSelect = document.getElementById('skill-select');
    const subSkillSelect = document.getElementById('subskill-select');
    const timeInput = document.getElementById('time-input');
    const registerBtn = document.getElementById('register-btn');
    const skillsList = document.getElementById('skills-list');
    const logList = document.getElementById('log-list');
    const descriptionContainer = document.querySelector('#page-descripcion .description-content');
    
    //================================================================================//
    //   SECCIÓN 5: LÓGICA DE NAVEGACIÓN (SPA - Single Page Application)              //
    //   Este código hace que los botones "Entrenamiento", "Misiones" y             //
    //   "Descripción" muestren su contenido sin que la página web se recargue.     //
    //================================================================================//
    const navButtons = document.querySelectorAll('.nav-btn');
    const pages = document.querySelectorAll('.page-content');
    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetPage = button.getAttribute('data-page');
            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            pages.forEach(page => {
                page.classList.toggle('active', page.id === 'page-' + targetPage);
            });
        });
    });

    //================================================================================//
    //   SECCIÓN 6: LÓGICA DE LA PÁGINA "DESCRIPCIÓN"                                 //
    //   Controla todo lo que pasa en la pestaña de descripción: muestra las         //
    //   habilidades, sus detalles y permite añadir o borrar "Habilidades Concretas".//
    //================================================================================//
    function renderDescriptionPage() {
        descriptionContainer.innerHTML = '';
        const mainTitle = document.createElement('h1');
        mainTitle.textContent = 'Descripción de Habilidades';
        descriptionContainer.appendChild(mainTitle);
        const categories = {
            combate: 'Habilidades de "Combate" (Proactivas y de Afrontamiento)',
            autocuidado: 'Habilidades de "Autocuidado"',
            artesania: 'Habilidades de "Artesanía" (Creación y Conocimiento)'
        };
        for (const categoryId in categories) {
            const categoryTitle = document.createElement('h3');
            categoryTitle.textContent = categories[categoryId];
            descriptionContainer.appendChild(categoryTitle);
            const categoryList = document.createElement('ul');
            categoryList.style.padding = '0';
            for (const skillName in skills) {
                if (skills[skillName].category === categoryId) {
                    const skill = skills[skillName];
                    const item = document.createElement('li');
                    item.className = 'description-item';
                    item.setAttribute('data-skill', skillName);
                    item.innerHTML = `
                        <div class="description-header">
                            <img src="${skill.img}" alt="Icono de ${skillName}" class="description-img">
                            <div><strong>${skillName}:</strong> ${skill.description}</div>
                        </div>
                        <div class="subskill-container">
                            <h4>Habilidades Concretas:</h4>
                            <ul class="subskill-list"></ul>
                            <div class="subskill-input-group">
                                <input type="text" placeholder="Añadir nueva habilidad..." maxlength="50">
                                <button class="add-subskill-btn">+</button>
                            </div>
                        </div>`;
                    categoryList.appendChild(item);
                }
            }
            descriptionContainer.appendChild(categoryList);
        }
        renderAllSubSkillLists();
        addDescriptionPageListeners();
    }
    
    function renderSubSkillList(skillName) {
        const listElement = document.querySelector(`.description-item[data-skill="${skillName}"] .subskill-list`);
        if (!listElement) return;
        listElement.innerHTML = '';
        if (skills[skillName] && skills[skillName].subSkills) {
            skills[skillName].subSkills.forEach((subSkill, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${subSkill}</span> <button class="delete-subskill-btn" data-index="${index}">X</button>`;
                listElement.appendChild(li);
            });
        }
    }
    function renderAllSubSkillLists() {
        for (const skillName in skills) { renderSubSkillList(skillName); }
    }
    function addDescriptionPageListeners() {
        descriptionContainer.addEventListener('click', (e) => {
            const target = e.target;
            const parentItem = target.closest('.description-item');
            if (!parentItem) return;
            const skillName = parentItem.getAttribute('data-skill');
            if (target.classList.contains('add-subskill-btn')) {
                const input = parentItem.querySelector('input[type="text"]');
                const value = input.value.trim();
                if (value && skills[skillName].subSkills.length < 25) {
                    skills[skillName].subSkills.push(value);
                    renderSubSkillList(skillName);
                    populateSubSkillSelect(skillSelect.value);
                    input.value = '';
                }
            }
            if (target.classList.contains('delete-subskill-btn')) {
                const index = parseInt(target.getAttribute('data-index'));
                skills[skillName].subSkills.splice(index, 1);
                renderSubSkillList(skillName);
                populateSubSkillSelect(skillSelect.value);
            }
        });
    }

    //================================================================================//
    //   SECCIÓN 7: INICIALIZACIÓN DE LA API DE GOOGLE                                //
    //   Este bloque se encarga de cargar y preparar las herramientas de Google      //
    //   para que podamos usarlas (iniciar sesión, guardar/cargar archivos).        //
    //================================================================================//
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const FILENAME = 'progreso_agenda.json';
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    function gapiLoaded() { gapi.load('client', initializeGapiClient); }
    async function initializeGapiClient() {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS, });
        gapiInited = true; maybeEnableButtons();
    }
    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '', });
        gisInited = true; maybeEnableButtons();
    }
    function maybeEnableButtons() { if (gapiInited && gisInited) { authBtn.style.display = 'block'; } }
    authBtn.onclick = () => handleAuthClick();
    function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) { throw (resp); }
            authBtn.textContent = 'Refrescar Sesión';
            saveBtn.disabled = false; loadBtn.disabled = false;
            statusDiv.textContent = '¡Sesión iniciada! Listo para sincronizar.';
        };
        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
            tokenClient.requestAccessToken({prompt: ''});
        }
    }
    
    //================================================================================//
    //   SECCIÓN 8: FUNCIONES PRINCIPALES DE GOOGLE DRIVE                             //
    //   Aquí está la magia para conectar con la nube. Estas funciones buscan el     //
    //   archivo de guardado, lo crean si no existe, guardan el progreso y lo cargan.//
    //================================================================================//
    async function findFileId() {
        try {
            const response = await gapi.client.drive.files.list({ 'q': `name='${FILENAME}' and trashed=false`, 'fields': 'files(id, name)', 'spaces': 'drive' });
            return response.result.files && response.result.files.length > 0 ? response.result.files[0].id : null;
        } catch (err) { addLogEntry(`Error buscando archivo: ${err.message}`, 'level-up'); return null; }
    }
    saveBtn.onclick = async () => {
        statusDiv.textContent = 'Guardando en Google Drive...';
        const fileId = await findFileId();
        const fileContent = JSON.stringify(skills, null, 2);
        const boundary = '-------314159265358979323846';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";
        let metadata, requestBody;
        if (fileId) {
            metadata = { 'mimeType': 'application/json' };
            requestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter + 'Content-Type: application/json\r\n\r\n' + fileContent + close_delim;
            const request = gapi.client.request({
                'path': `/upload/drive/v3/files/${fileId}`, 'method': 'PATCH', 'params': { 'uploadType': 'multipart' },
                'headers': { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' }, 'body': requestBody
            });
            request.execute(() => { statusDiv.textContent = '¡Progreso guardado!'; addLogEntry('💾 Progreso guardado en la nube.'); });
        } else {
            metadata = { 'name': FILENAME, 'mimeType': 'application/json' };
            requestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter + 'Content-Type: application/json\r\n\r\n' + fileContent + close_delim;
            const createRequest = gapi.client.request({
                'path': '/upload/drive/v3/files', 'method': 'POST', 'params': { 'uploadType': 'multipart' },
                'headers': { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' }, 'body': requestBody
            });
            createRequest.execute(() => { statusDiv.textContent = '¡Archivo creado y guardado!'; addLogEntry('💾 Archivo de progreso creado.'); });
        }
    };
    loadBtn.onclick = async () => {
        statusDiv.textContent = 'Cargando desde Google Drive...';
        const fileId = await findFileId();
        if (!fileId) { statusDiv.textContent = 'No se encontró archivo de progreso.'; addLogEntry('⚠️ No se encontró archivo.', 'level-up'); return; }
        try {
            const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
            const loadedSkills = JSON.parse(response.body);
            if (loadedSkills && typeof loadedSkills === 'object') {
                const hydratedSkills = JSON.parse(JSON.stringify(initialSkills));
                let migrationApplied = false;
                
                for (const savedSkillName in loadedSkills) {
                    let targetSkillName = savedSkillName;

                    while (MIGRATION_MAP[targetSkillName]) {
                        targetSkillName = MIGRATION_MAP[targetSkillName];
                        migrationApplied = true;
                    }
                    
                    if (hydratedSkills[targetSkillName]) {
                        const savedData = loadedSkills[savedSkillName];
                        hydratedSkills[targetSkillName].xp += savedData.xp || 0;
                        hydratedSkills[targetSkillName].level = getLevelFromXp(hydratedSkills[targetSkillName].xp);
                        const combinedSubSkills = new Set([...hydratedSkills[targetSkillName].subSkills, ...(savedData.subSkills || [])]);
                        hydratedSkills[targetSkillName].subSkills = Array.from(combinedSubSkills);
                    }
                }
                
                skills = hydratedSkills;
                
                updateDisplay(); 
                populateSelect(); 
                renderDescriptionPage();
                statusDiv.textContent = '¡Progreso cargado desde Drive!'; 
                addLogEntry('📂 Progreso cargado.');
                if (migrationApplied) {
                    addLogEntry('✨ ¡Datos migrados a la nueva versión! Guarda para actualizar el archivo.', 'level-up');
                }
            } else { throw new Error("Formato de datos inválido en el archivo de Drive."); }
        } catch (err) { statusDiv.textContent = `Error al cargar: ${err.message}`; addLogEntry(`❌ Error al cargar: ${err.message}`, 'level-up'); }
    };

    //================================================================================//
    //   SECCIÓN 9: LÓGICA CENTRAL DE LA APLICACIÓN (EL "MOTOR" DEL JUEGO)            //
    //   Este es el corazón del panel. Calcula los niveles, actualiza la lista de   //
    //   habilidades, rellena los menús desplegables y gestiona el registro de XP.  //
    //================================================================================//
    const XP_PER_15_MINS = 100;
    
    // Calcula a qué nivel corresponde una cantidad de XP.
    function getLevelFromXp(xp) {
        let level = 1; while (true) { let xpForNextLevel = Math.pow(level, 2) * 1000; if (xp < xpForNextLevel) return level; level++; if (level > 200) return 200; }
    }

    // Dibuja y actualiza la lista de habilidades en la página principal.
    function updateDisplay() {
        skillsList.innerHTML = ''; const sortedSkills = Object.entries(skills).sort(([,a],[,b]) => b.xp - a.xp);
        for (const [skillName, skill] of sortedSkills) {
            const li = document.createElement('li'); const xpForCurrentLevel = skill.level > 1 ? Math.pow(skill.level - 1, 2) * 1000 : 0;
            const xpForNextLevel = Math.pow(skill.level, 2) * 1000; const xpInCurrentLevel = skill.xp - xpForCurrentLevel;
            const xpNeededForLevel = xpForNextLevel - xpForCurrentLevel; const progressPercentage = (xpInCurrentLevel / xpNeededForLevel) * 100;
            li.innerHTML = `<div style="flex-grow: 1;"><span><span class="skill-icon">${skill.icon || '❔'}</span>${skillName}</span><div style="font-size: 0.8em; color: #a0a0c0;">Lvl: ${skill.level} (${skill.xp.toLocaleString()} XP)</div></div><div class="progress-bar-bg"><div class="progress-bar-fg" style="width: ${progressPercentage}%;"></div></div>`;
            skillsList.appendChild(li);
        }
    }

    // Rellena los menús desplegables de "Habilidad General" y "Habilidad Concreta".
    function populateSelect() {
        skillSelect.innerHTML = ''; const skillNames = Object.keys(skills); skillNames.sort();
        for (const skillName of skillNames) { const option = document.createElement('option'); option.value = skillName; option.textContent = skillName; skillSelect.appendChild(option); }
        populateSubSkillSelect(skillSelect.value);
    }
    function populateSubSkillSelect(selectedSkill) {
        subSkillSelect.innerHTML = '';
        if (skills[selectedSkill] && skills[selectedSkill].subSkills && skills[selectedSkill].subSkills.length > 0) {
            skills[selectedSkill].subSkills.forEach(subSkill => {
                const option = document.createElement('option');
                option.value = subSkill;
                option.textContent = subSkill;
                subSkillSelect.appendChild(option);
            });
            subSkillSelect.disabled = false;
        } else {
            const option = document.createElement('option');
            option.textContent = 'Sin habilidades concretas';
            option.disabled = true;
            subSkillSelect.appendChild(option);
            subSkillSelect.disabled = true;
        }
    }
    
    // Actualiza el menú de sub-habilidades cuando cambia la habilidad general.
    skillSelect.addEventListener('change', (e) => {
        populateSubSkillSelect(e.target.value);
    });

    // Añade una nueva línea de texto al panel de "Registro" en la barra lateral.
    function addLogEntry(message, type = '') {
        const logEntry = document.createElement('li'); logEntry.textContent = message; if (type) logEntry.classList.add(type);
        logList.prepend(logEntry); if (logList.children.length > 20) logList.removeChild(logList.lastChild);
    }

    //================================================================================//
    //   SECCIÓN 10: EVENTO PRINCIPAL - REGISTRAR EXPERIENCIA (XP)                    //
    //   Esta es la acción que se dispara al pulsar el botón "Registrar XP".         //
    //   Toma los datos de los inputs, calcula el XP ganado y actualiza todo.        //
    //================================================================================//
    registerBtn.addEventListener('click', () => {
        const selectedSkill = skillSelect.value;
        const selectedSubSkill = subSkillSelect.value;
        const timeSpent = parseInt(timeInput.value);
        if (!selectedSkill || isNaN(timeSpent) || timeSpent <= 0) { addLogEntry('Entrada inválida.', 'level-up'); return; }
        const xpGained = Math.floor((timeSpent / 15) * XP_PER_15_MINS); const skillData = skills[selectedSkill];
        const oldLevel = skillData.level; skillData.xp += xpGained; skillData.level = getLevelFromXp(skillData.xp);
        
        let logMessage = `+${xpGained.toLocaleString()} XP en ${skillData.icon} ${selectedSkill}`;
        if (selectedSubSkill && !subSkillSelect.disabled) {
            logMessage += ` (${selectedSubSkill})`;
        }
        logMessage += ` (${timeSpent} min).`;
        addLogEntry(logMessage);

        if (skillData.level > oldLevel) { addLogEntry(`¡Nivel ${skillData.level} en ${selectedSkill}!`, 'level-up'); }
        timeInput.value = ''; updateDisplay();
    });
    
    //================================================================================//
    //   SECCIÓN 11: INICIALIZACIÓN PRINCIPAL DE LA APLICACIÓN                        //
    //   Esto es lo primero que se ejecuta cuando la página ha cargado por completo.  //
    //   Prepara la aplicación para que el usuario pueda empezar a usarla.           //
    //================================================================================//
    window.onload = () => { 
        skills = JSON.parse(JSON.stringify(initialSkills));
        populateSelect(); 
        updateDisplay(); 
        renderDescriptionPage();
        addLogEntry('¡Bienvenido, aventurero!'); 
    };
    </script>
    
    <!-- Scripts de Google -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
�
