<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Aventurero v9.10 (Gr√°fico Radial)</title>
    <!-- Importaci√≥n de la librer√≠a Chart.js para los gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ==========================================================================
           1. IMPORTACI√ìN DE FUENTES E INICIALIZACI√ìN
           ========================================================================== */
        
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        html {
            font-size: 100%; 
            scroll-behavior: smooth;
        }

        /* ==========================================================================
           2. ESTILOS GENERALES DEL CUERPO (BODY)
           ========================================================================== */
        
        body {
            background-color: #1e1e2f;
            color: #dcdcdc;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        /* ==========================================================================
           3. ESTRUCTURA Y LAYOUT PRINCIPAL
           ========================================================================== */

        .main-container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .sidebar {
            width: 280px;
            flex-shrink: 0;
            position: sticky;
            top: 20px;
        }

        .main-content {
            flex-grow: 1;
        }

        /* ==========================================================================
           4. ESTILOS DE LOS CONTENEDORES (PANELES)
           ========================================================================== */

        .container {
            border: 3px solid #4f4f6f;
            background-color: #2a2a40;
            padding: 20px;
            width: 100%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            border-radius: 8px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        /* ==========================================================================
           5. TIPOGRAF√çA (T√çTULOS Y TEXTOS)
           ========================================================================== */

        h1, h2 {
            color: #ffdd57;
            text-align: center;
            border-bottom: 2px solid #4f4f6f;
            padding-bottom: 10px;
            margin-top: 0;
            font-size: 1.5rem;
            text-shadow: 2px 2px #c23616;
        }

        h2 { font-size: 1.2rem; }
        h3 { font-size: 1rem; color: #4a90e2; margin-top: 20px; text-align: center; }
        h4 { font-size: 0.8rem; color: #a0a0c0; margin-bottom: 10px; border-top: 1px solid #4f4f6f; padding-top: 15px; margin-top: 15px;}

        label {
            display: block;
            margin-bottom: 8px;
            color: #a0a0c0;
            font-size: 0.8rem;
        }

        /* ==========================================================================
           6. ELEMENTOS DE FORMULARIO Y BOTONES
           ========================================================================== */

        select, input[type="number"], input[type="text"], input[type="date"], input[type="time"], textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background-color: #1e1e2f;
            color: #dcdcdc;
            border: 2px solid #4f4f6f;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9rem;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button, .nav-btn, .type-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            color: #FFFFFF;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-family: inherit;
            text-align: center;
            transition: all 0.1s ease-in-out;
            display: block;
            font-size: 0.8rem;
        }
        
        #register-btn, #create-mission-btn { background: linear-gradient(145deg, #4a90e2, #3a7ac8); border-bottom: 4px solid #2a5a9a; }
        #auth-btn { background-color: #dd4b39; border-bottom: 4px solid #c23321;}
        .gdrive-btn { background-color: #4CAF50; border-bottom: 4px solid #388E3C; }
        #reset-progress-btn { background-color: #c23616; border-bottom: 4px solid #8e240e;}
        .nav-btn { background-color: #6a4f9a; border-bottom: 4px solid #4a2f7a; }
        .nav-btn.active { background-color: #8a6fba; transform: translateY(2px); border-bottom-width: 2px;}
        button:disabled { background-color: #555; border-bottom-color: #444; color: #888; cursor: not-allowed; }

        .type-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .type-btn { background-color: #555; border-bottom: 4px solid #444; width: 50%; }
        .type-btn.active { background-color: #4a90e2; border-bottom-color: #2a5a9a; transform: translateY(2px); border-bottom-width: 2px; }

        #unit-input-container { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        #unit-check { width: auto; height: 20px; }


        /* ==========================================================================
           7. PANELES ESPEC√çFICOS Y LISTAS
           ========================================================================== */
        
        .chart-container {
            position: relative;
            min-height: 300px; /* Aumentado para mejor visualizaci√≥n */
            padding: 15px;
            background: #1e1e2f;
            border-radius: 5px;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        .skills-panel ul, .log-panel ul, .mission-list ul {
            list-style: none;
            padding: 0;
            max-height: 450px;
            overflow-y: auto;
        }
        
        .skills-panel li {
            background-color: #33334f;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-left: 5px solid #ffdd57;
            display: block;
            border-radius: 4px;
        }
        .skill-info-container {
             display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .skill-name { font-weight: bold; }
        .skill-meta { font-size: 0.7rem; color: #a0a0c0; text-align: right; }
        
        .description-item {
            display: flex; flex-direction: column; align-items: flex-start; gap: 15px;
            background-color: #33334f; padding: 15px; margin-bottom: 10px;
            border-left: 5px solid #ffdd57; border-radius: 4px;
            font-size: 0.75rem; line-height: 1.5;
        }
        .description-header { display: flex; align-items: center; gap: 15px; width: 100%;}
        .description-img { width: 80px; height: 80px; border-radius: 4px; flex-shrink: 0; object-fit: cover; }
        
        .subskill-container { width: 100%; }
        .subskill-list { list-style: none; padding: 0; }
        .subskill-list li { 
            display: flex; 
            flex-direction: column;
            align-items: flex-start; 
            background-color: #2a2a40; 
            padding: 12px; 
            border-radius: 3px; 
            margin-bottom: 8px;
            font-size: 0.9rem;
            gap: 10px;
            border-left: 3px solid #6a4f9a;
        }
        .subskill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .subskill-actions {
            display: flex;
            gap: 5px;
        }
        .session-history {
            width: 100%;
            margin-top: 10px;
            border-top: 1px solid #4f4f6f;
            padding-top: 10px;
            font-size: 0.7rem;
            color: #a0a0c0;
        }
        .session-entry {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            padding: 4px;
            border-radius: 2px;
        }
        .session-entry:nth-child(odd) {
            background-color: #33334f;
        }
        .xp-earned {
            color: #32ff7e;
            font-weight: bold;
        }
        .subskill-input-group { display: flex; gap: 10px; align-items: center; }
        
        .edit-subskill-btn, .delete-subskill-btn { 
            border: none; color: white; padding: 5px 8px;
            border-radius: 3px; cursor: pointer; font-family: inherit; font-size: 0.8rem;
            width: auto;
            flex-shrink: 0;
        }
        .edit-subskill-btn { background: #4a90e2; }
        .delete-subskill-btn { background: #c23616; }
        
        .add-subskill-btn { flex-shrink: 0; width: auto; padding: 0 15px; font-size: 1.2rem; background-color: #4CAF50; border-bottom: 4px solid #388E3C; }
        
        .skill-icon { margin-right: 10px; }
        
        /* Log Panel, Progress Bar & Modal Styles */
        .log-panel ul { max-height: 400px; }
        .log-panel li { font-size: 0.75rem; padding: 8px; border-radius: 4px; line-height: 1.5; }
        .log-panel .level-up { border-left: 3px solid #32ff7e; background-color: rgba(50, 255, 126, 0.1); }
        .error { color: #ff4757; }
        .log-entry { display: grid; grid-template-columns: auto 1fr; gap: 5px 10px; align-items: center;}
        .xp-gain { grid-column: 1 / 2; grid-row: 1 / 3; font-weight: bold; color: #32ff7e; font-size: 1rem; }
        .skill-info { grid-column: 2 / 3; font-weight: bold; }
        .activity-details { grid-column: 2/3; font-size: 0.8rem; color: #a0a0c0; }
        .evaluation { grid-column: 1 / 3; display: flex; gap: 15px; margin-top: 5px; font-size: 0.65rem; }
        .intensity.bajo { color: #1e90ff; } .intensity.medio { color: #dcdcdc; } .intensity.alto { color: #ffdd57; }
        .performance.malo { color: #ff4757; } .performance.normal { color: #dcdcdc; } .performance.bueno { color: #32ff7e; }
        .level-up .level-up { text-align: center; font-size: 0.8rem; color: #ffdd57; }
        .level-progress { font-size: 0.7rem; color: #a0a0c0; margin-top: 5px; }

        #gdrive-status { text-align: center; font-size: 0.7rem; padding: 10px; color: #a0a0c0; min-height: 20px; }
        
        .progress-bar-bg { position: relative; background-color: #1e1e2f; border-radius: 5px; height: 18px; width: 100%; border: 1px solid #4f4f6f; overflow: hidden; }
        .progress-bar-fg { background-color: #32ff7e; height: 100%; border-radius: 5px; }
        .progress-text { position: absolute; width: 100%; text-align: center; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.65rem; color: #1e1e2f; font-weight: bold; text-shadow: 0 0 2px #dcdcdc; }

        .page-content { display: none; }
        .page-content.active { display: block; }
        
        #version-info {
            font-size: 0.65rem; color: #8a8a9e; text-align: right;
            margin-top: 15px; padding-top: 10px;
            border-top: 1px solid #4f4f6f; line-height: 1.4;
        }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #2a2a40; padding: 30px; border-radius: 8px; border: 2px solid #ffdd57; text-align: center; max-width: 400px; }
        .modal-content h3 { margin-top: 0; font-size: 1.2rem; }
        .modal-content p { font-size: 0.9rem; margin-bottom: 20px; }
        .modal-actions { display: flex; justify-content: center; gap: 15px; }
        .modal-btn { width: 120px; }
        .modal-btn.confirm { background-color: #c23616; border-bottom: 4px solid #8e240e; }
        .modal-btn.cancel { background-color: #555; border-bottom: 4px solid #444; }
        
        /* ==========================================================================
           8. DISE√ëO RESPONSIVO (PARA M√ìVILES)
           ========================================================================== */

        @media (max-width: 800px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100%; position: static; }
            .description-header { flex-direction: column; text-align: center; }
            html { font-size: 100%; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        
        <div class="sidebar">
            <div class="container">
                <h2>Navegaci√≥n</h2>
                <button class="nav-btn active" data-page="dashboard">Panel de Control</button> 
                <button class="nav-btn" data-page="entrenamiento">Entrenamiento</button>
                <button class="nav-btn" data-page="misiones">Misiones</button>
                <button class="nav-btn" data-page="descripcion">Descripci√≥n</button>
                <button class="nav-btn" data-page="configuracion">Configuraci√≥n</button>
            </div>
            
            <div class="container gdrive-section">
                <div id="gdrive-status">Inicia sesi√≥n para sincronizar.</div>
                <button id="auth-btn">Iniciar Sesi√≥n con Google</button>
                <button id="save-drive-btn" class="gdrive-btn" disabled>Guardar datos</button>
                <button id="load-drive-btn" class="gdrive-btn" disabled>Cargar el poder</button>
            </div>

             <div class="container log-panel">
                <h2>Registro</h2>
                <ul id="log-list"></ul>
                <div id="version-info">
                     v9.9 (Misiones y Notificaciones)
                </div>
            </div>
        </div>

        <div class="main-content">
            
            <div id="page-dashboard" class="page-content active">
                <div class="container">
                    <h1>Panel de Control</h1>
                    <div id="dashboard-charts-container"></div>
                </div>
            </div>

            <div id="page-entrenamiento" class="page-content">
                <div class="container">
                    <h1>Panel de Aventurero</h1>
                    <div class="input-section">
                        <label for="skill-select">Habilidad General:</label>
                        <select id="skill-select"></select>
                        <label for="subskill-select">Habilidad Concreta:</label>
                        <select id="subskill-select"></select>
                        <div id="activity-type-container">
                            <label>Tipo de Actividad:</label>
                            <div class="type-selector">
                                <button type="button" id="temporal-type-btn" class="type-btn active">Tiempo ‚è±Ô∏è</button>
                                <button type="button" id="discrete-type-btn" class="type-btn">Unidad ‚úÖ</button>
                            </div>
                        </div>
                        <div id="time-input-container">
                            <label for="time-input">Minutos de pr√°ctica:</label>
                            <input type="number" id="time-input" min="1" placeholder="Ej: 30">
                        </div>
                        <div id="unit-input-container" style="display: none;">
                            <label for="unit-check">Actividad cumplida:</label>
                            <input type="checkbox" id="unit-check">
                        </div>
                        <label for="intensity-select">Intensidad:</label>
                        <select id="intensity-select">
                            <option value="bajo">Bajo (x0.8)</option>
                            <option value="medio" selected>Medio (x1.0)</option>
                            <option value="alto">Alto (x1.2)</option>
                        </select>
                        <label for="performance-select">Desempe√±o:</label>
                        <select id="performance-select">
                            <option value="malo">Malo (x0.7)</option>
                            <option value="normal" selected>Normal (x1.0)</option>
                            <option value="bueno">Bueno (x1.3)</option>
                        </select>
                        <button id="register-btn">Registrar XP</button>
                    </div>
                </div>
                <div class="container skills-panel">
                    <h2>Habilidades</h2>
                    <ul id="skills-list"></ul>
                </div>
            </div>

            <div id="page-misiones" class="page-content">
                <div class="container">
                    <h1>Misiones</h1>
                    <div class="mission-form">
                        <label for="mission-title">T√≠tulo de la Misi√≥n:</label>
                        <input type="text" id="mission-title" placeholder="Ej: Practicar 30 minutos de guitarra">
                        <label for="mission-date">Fecha:</label>
                        <input type="date" id="mission-date">
                        <label for="mission-time">Hora:</label>
                        <input type="time" id="mission-time">
                        <label for="mission-description">Descripci√≥n (opcional):</label>
                        <textarea id="mission-description" placeholder="Notas adicionales para el recordatorio..."></textarea>
                        <button id="create-mission-btn">Crear Recordatorio en Google Calendar</button>
                    </div>
                </div>
            </div>

            <div id="page-descripcion" class="page-content">
                <div class="container description-content"></div>
            </div>

            <div id="page-configuracion" class="page-content">
                <div class="container">
                    <h1>Configuraci√≥n</h1>
                    <p style="text-align:center; line-height: 1.5;">Aqu√≠ puedes gestionar los datos de tu aplicaci√≥n.</p>
                    <h4>Zona de Peligro</h4>
                    <p style="font-size: 0.8rem; color: #a0a0c0; text-align:center; line-height: 1.5;">Esta acci√≥n borrar√° permanentemente tu archivo de progreso de Google Drive. No se puede deshacer.</p>
                    <button id="reset-progress-btn" disabled>Borrar Progreso en la Nube</button>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal de Confirmaci√≥n -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>¬øEst√°s seguro?</h3>
            <p>Todo tu progreso se borrar√° de Google Drive y la aplicaci√≥n se reiniciar√°. Esta acci√≥n no se puede deshacer.</p>
            <div class="modal-actions">
                <button id="confirm-delete-btn" class="modal-btn confirm">S√≠, borrar</button>
                <button id="cancel-delete-btn" class="modal-btn cancel">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
    //================================================================================//
    //  SECCI√ìN 1: CONFIGURACI√ìN DE ACCESO A GOOGLE DRIVE API                         //
    //================================================================================//
    const CLIENT_ID = '432634777489-acq7bb59h2ggc223oafccitlvskvqh6p.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyB17ehizwOK9efPy7Bo7Zss2zveYSVhwE8';
    
    //================================================================================//
    //  SECCI√ìN 2: ESTRUCTURA DE DATOS INICIAL                                        //
    //================================================================================//
    const initialSkills = {
        'Avance (Formaci√≥n)': { xp: 0, level: 1, icon: '‚öîÔ∏è', subSkills: {}, img: 'https://placehold.co/80x80/c23616/FFFFFF?text=‚öîÔ∏è', category: 'combate', description: 'Todo lo que impulsa tu carrera. Estudiar, hacer networking, desarrollar un proyecto laboral, buscar un ascenso, trabajar en equipo, puntualidad.' },
        'Fuerza (Salud centrada en el cuerpo)': { xp: 0, level: 1, icon: 'üí™', subSkills: {}, img: 'https://placehold.co/80x80/e84118/FFFFFF?text=üí™', category: 'combate', description: 'Entrenamiento de fuerza, levantamiento de pesas, calistenia, funcional.' },
        'Defensa (Finanzas Personales)': { xp: 0, level: 1, icon: 'üõ°Ô∏è', subSkills: {}, img: 'https://placehold.co/80x80/4cd137/FFFFFF?text=üõ°Ô∏è', category: 'combate', description: 'Ahorrar, invertir, crear un presupuesto, aprender sobre econom√≠a, pagar deudas.' },
        'Constituci√≥n (Salud y Resistencia)': { xp: 0, level: 1, icon: '‚ù§Ô∏è', subSkills: {}, img: 'https://placehold.co/80x80/ff4757/FFFFFF?text=‚ù§Ô∏è', category: 'combate', description: 'Dormir bien, mantenerse hidratado, procurar cumplir con los ciclos circadianos, chequeos m√©dicos, ba√±os de agua helada.' },
        'Agilidad (Salud centrada en cuerpo)': { xp: 0, level: 1, icon: 'üèÉ', subSkills: {}, img: 'https://placehold.co/80x80/1e90ff/FFFFFF?text=üèÉ', category: 'combate', description: 'Actividades de Cardio y Flexibilidad como correr, nadar, yoga, ciclismo, estiramientos, gimnasia funcional.' },
        'Magia (Habilidades Sociales)': { xp: 0, level: 1, icon: '‚ú®', subSkills: {}, img: 'https://placehold.co/80x80/8c7ae6/FFFFFF?text=‚ú®', category: 'combate', description: 'Comunicaci√≥n, oratoria, negociaci√≥n, empat√≠a, inteligencia emocional, psicoterapia, compa√±erismo' },
        'Espiritual (Salud Mental)': { xp: 0, level: 1, icon: 'üßò', subSkills: {}, img: 'https://placehold.co/80x80/718093/FFFFFF?text=üßò', category: 'autocuidado', description: 'Meditar, Mindfulness, escribir un diario, practicar la gratitud, terapias, plegarias, amor, amistades' },
        'Nutrici√≥n (Salud corporal)': { xp: 0, level: 1, icon: 'üåø', subSkills: {}, img: 'https://placehold.co/80x80/27ae60/FFFFFF?text=üåø', category: 'autocuidado', description: 'Aprender sobre macronutrientes, planificar comidas saludables, reducir procesados.' },
        'Cocina (Pr√°ctica)': { xp: 0, level: 1, icon: 'üç≥', subSkills: {}, img: 'https://placehold.co/80x80/fbc531/FFFFFF?text=üç≥', category: 'autocuidado', description: 'Preparar tus propias comidas, aprender nuevas recetas, batch cooking.' },
        'Hobbies y Relajaci√≥n (en la Nada y en el Todo a la vez)': { xp: 0, level: 1, icon: 'üåå', subSkills: {}, img: 'https://placehold.co/80x80/3498db/FFFFFF?text=üåå', category: 'autocuidado', description: 'Dedicar tiempo a pasatiempos que te relajen y disfrutes sin un fin productivo. Leer ficci√≥n, tocar un instrumento, pintar, pescar.' },
        'Estudio Profundo': { xp: 0, level: 1, icon: 'üìö', subSkills: {}, img: 'https://placehold.co/80x80/9b59b6/FFFFFF?text=üìö', category: 'artesania', description: 'Aprender una habilidad "dura" y compleja. Programaci√≥n, un nuevo idioma, carpinter√≠a, edici√≥n de video.' },
        'Creaci√≥n (Proyectos Creativos)': { xp: 0, level: 1, icon: 'üé®', subSkills: {}, img: 'https://placehold.co/80x80/e74c3c/FFFFFF?text=üé®', category: 'artesania', description: 'Escribir, dibujar, componer m√∫sica, crear contenido para tus seres queridos o las redes.' },
        'Construcci√≥n (Organizaci√≥n)': { xp: 0, level: 1, icon: 'üè°', subSkills: {}, img: 'https://placehold.co/80x80/f39c12/FFFFFF?text=üè°', category: 'artesania', description: 'Ordenar tu casa, optimizar tu espacio de trabajo, bricolaje (DIY), minimalismo.'},
        'Grabaci√≥n de Fuego (Disciplina)': { xp: 0, level: 1, icon: 'üî•', subSkills: {}, img: 'https://placehold.co/80x80/d35400/FFFFFF?text=üî•', category: 'artesania', description: 'La habilidad "meta". Se enfoca en el acto de construir y mantener la rutina. La clave es la simplicidad y la consistencia.' }
    };
    
    const MIGRATION_MAP = {
        "Ataque (Carrera)": "Avance (Formaci√≥n)", "Fuerza (Fitness)": "Fuerza (Salud centrada en el cuerpo)", "Agilidad (Cardio)": "Agilidad (Salud centrada en cuerpo)", "Oraci√≥n (Mindfulness)": "Espiritual (Salud Mental)", "Herbolog√≠a (Nutrici√≥n)": "Nutrici√≥n (Salud corporal)", "Pesca (Hobbies)": "Hobbies y Relajaci√≥n", "Herrer√≠a (Estudio)": "Estudio Profundo", "Creaci√≥n de Fuego (Disciplina y H√°bitos)": "Grabaci√≥n de Fuego (Disciplina)", "Hobbies y Relajaci√≥n": "Hobbies y Relajaci√≥n (en la Nada y en el Todo a la vez)"
    };

    let skills = {};
    let chartInstances = {};
    
    //================================================================================//
    //  SECCI√ìN 3: CONSTANTES DE L√ìGICA DE JUEGO                                      //
    //================================================================================//
    const XP_PER_15_MINS = 100;
    const XP_PER_UNIT = 150; 
    const INTENSITY_MULTIPLIERS = { bajo: 0.8, medio: 1.0, alto: 1.2 };
    const PERFORMANCE_MULTIPLIERS = { malo: 0.7, normal: 1.0, bueno: 1.3 };

    //================================================================================//
    //  SECCI√ìN 4: REFERENCIAS A ELEMENTOS DEL HTML (DOM)                             //
    //================================================================================//
    const authBtn = document.getElementById('auth-btn');
    const saveBtn = document.getElementById('save-drive-btn');
    const loadBtn = document.getElementById('load-drive-btn');
    const statusDiv = document.getElementById('gdrive-status');
    const skillSelect = document.getElementById('skill-select');
    const subSkillSelect = document.getElementById('subskill-select');
    const timeInput = document.getElementById('time-input');
    const registerBtn = document.getElementById('register-btn');
    const skillsList = document.getElementById('skills-list');
    const logList = document.getElementById('log-list');
    const descriptionContainer = document.querySelector('#page-descripcion .description-content');
    const intensitySelect = document.getElementById('intensity-select');
    const performanceSelect = document.getElementById('performance-select');
    const temporalBtn = document.getElementById('temporal-type-btn');
    const discreteBtn = document.getElementById('discrete-type-btn');
    const timeInputContainer = document.getElementById('time-input-container');
    const unitInputContainer = document.getElementById('unit-input-container');
    const unitCheck = document.getElementById('unit-check');
    const resetProgressBtn = document.getElementById('reset-progress-btn');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    // Nuevos elementos de Misiones
    const createMissionBtn = document.getElementById('create-mission-btn');
    const missionTitleInput = document.getElementById('mission-title');
    const missionDateInput = document.getElementById('mission-date');
    const missionTimeInput = document.getElementById('mission-time');
    const missionDescriptionInput = document.getElementById('mission-description');


    //================================================================================//
    //  SECCI√ìN 5: L√ìGICA DE NAVEGACI√ìN Y UI                                          //
    //================================================================================//
    const navButtons = document.querySelectorAll('.nav-btn');
    const pages = document.querySelectorAll('.page-content');
    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetPage = button.getAttribute('data-page');
            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            pages.forEach(page => page.classList.toggle('active', page.id === 'page-' + targetPage));
            if (targetPage === 'dashboard') renderDashboardCharts();
            if (window.matchMedia('(max-width: 800px)').matches) {
                document.getElementById('page-' + targetPage)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });

    function setupActivityTypeSwitcher() {
        temporalBtn.addEventListener('click', () => {
            temporalBtn.classList.add('active');
            discreteBtn.classList.remove('active');
            timeInputContainer.style.display = 'block';
            unitInputContainer.style.display = 'none';
        });
        discreteBtn.addEventListener('click', () => {
            discreteBtn.classList.add('active');
            temporalBtn.classList.remove('active');
            timeInputContainer.style.display = 'none';
            unitInputContainer.style.display = 'block';
        });
    }

    //================================================================================//
    //  SECCI√ìN 6: L√ìGICA DE LA P√ÅGINA "DESCRIPCI√ìN"                                  //
    //================================================================================//
    
    function renderDescriptionPage() {
        descriptionContainer.innerHTML = '<h1>Descripci√≥n de Habilidades</h1>';
        const categories = { combate: 'Habilidades de "Combate"', autocuidado: 'Habilidades de "Autocuidado"', artesania: 'Habilidades de "Artesan√≠a"' };
        for (const categoryId in categories) {
            const categoryTitle = document.createElement('h3');
            categoryTitle.textContent = categories[categoryId];
            descriptionContainer.appendChild(categoryTitle);
            const categoryList = document.createElement('ul');
            categoryList.style.padding = '0';
            for (const skillName in skills) {
                if (skills[skillName].category === categoryId) {
                    const skill = skills[skillName];
                    const item = document.createElement('li');
                    item.className = 'description-item';
                    item.setAttribute('data-skill', skillName);
                    item.innerHTML = `<div class="description-header"><img src="${skill.img}" alt="Icono" class="description-img"><div><strong>${skillName}:</strong> ${skill.description}</div></div><div class="subskill-container"><h4>Habilidades Concretas:</h4><ul class="subskill-list"></ul><div class="subskill-input-group"><input type="text" placeholder="A√±adir habilidad..." maxlength="50"><button class="add-subskill-btn">+</button></div></div>`;
                    categoryList.appendChild(item);
                }
            }
            descriptionContainer.appendChild(categoryList);
        }
        renderAllSubSkillLists();
        addDescriptionPageListeners();
    }
    
    function renderSubSkillList(skillName) {
        const listElement = document.querySelector(`.description-item[data-skill="${skillName}"] .subskill-list`);
        if (!listElement) return;
        listElement.innerHTML = '';
        const skill = skills[skillName];
        if (skill && skill.subSkills) {
            Object.entries(skill.subSkills).forEach(([subSkillName, subSkillData]) => {
                const li = document.createElement('li');
                let sessionsHTML = '<div class="session-history"><h5>Historial Reciente:</h5>';
                if (subSkillData.sessions && subSkillData.sessions.length > 0) {
                     subSkillData.sessions.slice().reverse().slice(0, 5).forEach(session => {
                        const dateStr = new Date(session.date).toLocaleDateString();
                        const activityTypeIcon = session.type === 'temporal' ? '‚è±Ô∏è' : '‚úÖ';
                        const activityDetail = session.type === 'temporal' ? `${session.time} min` : 'Unidad';
                        sessionsHTML += `<div class="session-entry"><span>${activityTypeIcon} ${dateStr}: ${activityDetail}</span><span class="xp-earned">+${session.xpEarned} XP</span></div>`;
                     });
                } else {
                    sessionsHTML += '<span>No hay sesiones registradas.</span>';
                }
                sessionsHTML += '</div>';
                li.innerHTML = `<div class="subskill-header"><span>${subSkillName}</span> <div class="subskill-actions"><button class="edit-subskill-btn" data-name="${subSkillName}" title="Editar nombre">‚úèÔ∏è</button><button class="delete-subskill-btn" data-name="${subSkillName}" title="Eliminar">üóëÔ∏è</button></div></div>${sessionsHTML}`;
                listElement.appendChild(li);
            });
        }
    }

    function renderAllSubSkillLists() {
        for (const skillName in skills) { renderSubSkillList(skillName); }
    }

    function addDescriptionPageListeners() {
        descriptionContainer.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const parentItem = target.closest('.description-item');
            if (!parentItem) return;
            const skillName = parentItem.getAttribute('data-skill');
            const skillData = skills[skillName];

            if (target.classList.contains('add-subskill-btn')) {
                const input = parentItem.querySelector('input[type="text"]');
                const value = input.value.trim();
                if (value && !skillData.subSkills.hasOwnProperty(value) && Object.keys(skillData.subSkills).length < 25) {
                    skillData.subSkills[value] = { xp: 0, sessions: [] };
                    renderSubSkillList(skillName);
                    populateSubSkillSelect(skillSelect.value);
                    input.value = '';
                } else if(skillData.subSkills.hasOwnProperty(value)) {
                    addLogEntry('‚ö†Ô∏è Ya existe una habilidad con ese nombre.', 'error');
                }
            }
            
            if (target.classList.contains('edit-subskill-btn')) {
                const oldName = target.getAttribute('data-name');
                const newName = prompt('Ingresa el nuevo nombre para la habilidad:', oldName);
                if (newName && newName.trim() !== '' && newName !== oldName && !skillData.subSkills.hasOwnProperty(newName)) {
                    Object.defineProperty(skillData.subSkills, newName, Object.getOwnPropertyDescriptor(skillData.subSkills, oldName));
                    delete skillData.subSkills[oldName];
                    renderSubSkillList(skillName);
                    populateSubSkillSelect(skillSelect.value);
                    addLogEntry(`‚úîÔ∏è "${oldName}" renombrada a "${newName}".`);
                } else if (newName && skillData.subSkills.hasOwnProperty(newName)) {
                    addLogEntry('‚ö†Ô∏è Ya existe una habilidad con ese nombre.', 'error');
                }
            }

            if (target.classList.contains('delete-subskill-btn')) {
                const subSkillNameToDelete = target.getAttribute('data-name');
                delete skillData.subSkills[subSkillNameToDelete];
                renderSubSkillList(skillName);
                populateSubSkillSelect(skillSelect.value);
                addLogEntry(`üóëÔ∏è Habilidad concreta "${subSkillNameToDelete}" eliminada.`);
            }
        });
    }

    //================================================================================//
    //  SECCI√ìN 7: INICIALIZACI√ìN DE LA API DE GOOGLE                                 //
    //================================================================================//
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const FILENAME = 'progreso_agenda_v4.json'; 
    const OLD_FILENAMES = ['progreso_agenda_v3.json', 'progreso_agenda_v2.json', 'progreso_agenda.json'];
    let tokenClient;
    let gapiInited = false, gisInited = false;
    
    function gapiLoaded() { gapi.load('client', initializeGapiClient); }
    async function initializeGapiClient() { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }); gapiInited = true; maybeEnableButtons(); }
    function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); gisInited = true; maybeEnableButtons(); }
    
    function maybeEnableButtons() { 
        if (gapiInited && gisInited) { 
            authBtn.style.display = 'block';
            resetProgressBtn.disabled = false;
        } 
    }

    function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) { throw (resp); }
            authBtn.textContent = 'Refrescar Sesi√≥n';
            saveBtn.disabled = false; loadBtn.disabled = false;
            statusDiv.textContent = '¬°Sesi√≥n iniciada! Listo para sincronizar.';
        };
        if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'});
        else tokenClient.requestAccessToken({prompt: ''});
    }
    authBtn.addEventListener('click', handleAuthClick);
    
    //================================================================================//
    //  SECCI√ìN 8: FUNCIONES DE DATOS (GOOGLE DRIVE Y LOCAL)                          //
    //================================================================================//
    
    async function findFileIdByName(name) {
        try {
            const response = await gapi.client.drive.files.list({ q: `name='${name}' and trashed=false`, fields: 'files(id, name)', spaces: 'drive' });
            return response.result.files.length > 0 ? response.result.files[0].id : null;
        } catch (err) {
            addLogEntry(`<span class="error">Error buscando archivo: ${err.message}</span>`);
            return null;
        }
    }

    saveBtn.onclick = async () => {
        statusDiv.textContent = 'Guardando en Google Drive...';
        const fileId = await findFileIdByName(FILENAME);
        const fileContent = JSON.stringify(skills, null, 2);
        const boundary = '-------314159265358979323846';
        const delimiter = `\r\n--${boundary}\r\n`;
        const close_delim = `\r\n--${boundary}--`;
        let metadata = { mimeType: 'application/json' };
        let requestBody;
        if (fileId) {
            requestBody = `${delimiter}Content-Type: application/json\r\n\r\n${JSON.stringify(metadata)}${delimiter}Content-Type: application/json\r\n\r\n${fileContent}${close_delim}`;
            const request = gapi.client.request({ path: `/upload/drive/v3/files/${fileId}`, method: 'PATCH', params: { uploadType: 'multipart' }, headers: { 'Content-Type': `multipart/related; boundary="${boundary}"` }, body: requestBody });
            request.execute(() => { statusDiv.textContent = '¬°Progreso guardado!'; addLogEntry('üíæ Progreso guardado en la nube.'); });
        } else {
            metadata.name = FILENAME;
            requestBody = `${delimiter}Content-Type: application/json\r\n\r\n${JSON.stringify(metadata)}${delimiter}Content-Type: application/json\r\n\r\n${fileContent}${close_delim}`;
            const createRequest = gapi.client.request({ path: '/upload/drive/v3/files', method: 'POST', params: { uploadType: 'multipart' }, headers: { 'Content-Type': `multipart/related; boundary="${boundary}"` }, body: requestBody });
            createRequest.execute(() => { statusDiv.textContent = '¬°Archivo creado y guardado!'; addLogEntry('üíæ Archivo de progreso creado.'); });
        }
    };
    
    loadBtn.onclick = async () => {
        statusDiv.textContent = 'Buscando archivos en Google Drive...';
        let fileId = null;
        for (const name of [FILENAME, ...OLD_FILENAMES]) {
            fileId = await findFileIdByName(name);
            if (fileId) break;
        }

        if (!fileId) {
            statusDiv.textContent = 'No se encontr√≥ archivo de progreso.';
            addLogEntry('‚ö†Ô∏è No se encontr√≥ archivo. Empezando de cero.');
            resetLocalData();
            return;
        }

        statusDiv.textContent = 'Cargando datos desde Google Drive...';
        try {
            const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
            const loadedSkills = JSON.parse(response.body);
            if (loadedSkills && typeof loadedSkills === 'object') {
                const hydratedSkills = JSON.parse(JSON.stringify(initialSkills));
                let migrationOccurred = false;
                for (const savedSkillName in loadedSkills) {
                    let targetSkillName = MIGRATION_MAP[savedSkillName] || savedSkillName;
                    if (hydratedSkills[targetSkillName]) {
                        const savedData = loadedSkills[savedSkillName];
                        hydratedSkills[targetSkillName].xp = savedData.xp || 0;
                        const newSubSkills = {};
                        if (savedData.subSkills && typeof savedData.subSkills === 'object') {
                            if (Array.isArray(savedData.subSkills)) { 
                                migrationOccurred = true;
                                savedData.subSkills.forEach(name => {
                                    newSubSkills[name] = { xp: 0, sessions: [] };
                                });
                            } else { 
                                for (const subName in savedData.subSkills) {
                                    const subData = savedData.subSkills[subName];
                                    newSubSkills[subName] = { xp: subData.xp || 0, sessions: subData.sessions || [] };
                                    if(subData.type) migrationOccurred = true;
                                }
                            }
                        }
                        hydratedSkills[targetSkillName].subSkills = newSubSkills;
                        hydratedSkills[targetSkillName].level = getLevelFromXp(hydratedSkills[targetSkillName].xp);
                    }
                }
                
                skills = hydratedSkills;
                statusDiv.textContent = '¬°Progreso cargado desde Drive!'; 
                addLogEntry('üìÇ Progreso cargado.');
                if (migrationOccurred) {
                    addLogEntry('‚ú® Datos antiguos migrados. Guarda para actualizar al nuevo formato.', 'level-up');
                }
            } else { throw new Error("Formato de datos inv√°lido."); }
        } catch (err) { statusDiv.textContent = `Error: ${err.message}`; addLogEntry(`<span class="error">‚ùå Error: ${err.message}</span>`); }
        finally {
            updateAllUI();
        }
    };

    resetProgressBtn.addEventListener('click', () => {
        confirmModal.style.display = 'flex';
    });

    cancelDeleteBtn.addEventListener('click', () => {
        confirmModal.style.display = 'none';
    });

    confirmDeleteBtn.addEventListener('click', async () => {
        confirmModal.style.display = 'none';
        statusDiv.textContent = 'Borrando datos en la nube...';
        addLogEntry('üóëÔ∏è Intentando borrar el progreso en la nube...');
        try {
            const fileId = await findFileIdByName(FILENAME);
            if(fileId) {
                await gapi.client.drive.files.delete({ fileId: fileId });
                 addLogEntry('‚úîÔ∏è Archivo de progreso borrado de Google Drive.');
            } else {
                 addLogEntry('‚ÑπÔ∏è No se encontr√≥ archivo en la nube para borrar.');
            }
        } catch (err) {
            addLogEntry(`<span class="error">‚ùå No se pudo borrar el archivo: ${err.message}</span>`);
        } finally {
            resetLocalData();
        }
    });

    function resetLocalData() {
        skills = JSON.parse(JSON.stringify(initialSkills));
        logList.innerHTML = '';
        addLogEntry('üöÄ ¬°Progreso reiniciado! Listo para un nuevo comienzo.');
        updateAllUI();
    }
    
    function updateAllUI() {
        updateDisplay(); 
        populateSkillSelect(); 
        renderDescriptionPage(); 
        renderDashboardCharts();
    }


    //================================================================================//
    //  SECCI√ìN 9: L√ìGICA CENTRAL REFACTORIZADA                                       //
    //================================================================================//

    function getXpForLevel(level) {
        return Math.pow(level, 2) * 1000;
    }

    function getLevelFromXp(xp) {
        if (xp < getXpForLevel(1)) return 1;
        const level = Math.floor(Math.sqrt(xp / 1000));
        return Math.min(level + 1, 200);
    }

    function calculateSkillProgress(skill) {
        const xpForCurrentLevel = skill.level > 1 ? getXpForLevel(skill.level - 1) : 0;
        const xpForNextLevel = getXpForLevel(skill.level);
        const xpInCurrentLevel = skill.xp - xpForCurrentLevel;
        const xpNeededForLevel = xpForNextLevel - xpForCurrentLevel;
        
        return {
            progressPercentage: xpNeededForLevel > 0 
                ? (xpInCurrentLevel / xpNeededForLevel) * 100 
                : 0,
        };
    }

    function renderDashboardCharts() {
        const container = document.getElementById('dashboard-charts-container');
        if (!container) return;
        
        container.innerHTML = '';
        Object.values(chartInstances).forEach(chart => chart.destroy());
        chartInstances = {};

        const CATEGORIES = {
            combate: { name: 'Habilidades de "Combate"', color: '#e84118', bgColor: 'rgba(232, 65, 24, 0.2)' },
            autocuidado: { name: 'Habilidades de "Autocuidado"', color: '#4cd137', bgColor: 'rgba(76, 209, 55, 0.2)' },
            artesania: { name: 'Habilidades de "Artesan√≠a"', color: '#9b59b6', bgColor: 'rgba(155, 89, 182, 0.2)' }
        };

        // --- Gr√°fico Radial ---
        const radarTitle = document.createElement('h3');
        radarTitle.textContent = 'Resumen General de Habilidades';
        const radarChartWrapper = document.createElement('div');
        radarChartWrapper.className = 'chart-container';
        const radarCanvas = document.createElement('canvas');
        radarChartWrapper.appendChild(radarCanvas);
        container.appendChild(radarTitle);
        container.appendChild(radarChartWrapper);
        
        const allSkillNames = Object.keys(skills);
        const radarDatasets = Object.entries(CATEGORIES).map(([catId, catData]) => {
            return {
                label: catData.name,
                data: allSkillNames.map(name => skills[name].category === catId ? skills[name].level : 0),
                fill: true,
                backgroundColor: catData.bgColor,
                borderColor: catData.color,
                pointBackgroundColor: catData.color,
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: catData.color
            }
        });

        chartInstances.radar = new Chart(radarCanvas, {
            type: 'radar',
            data: {
                labels: allSkillNames.map(name => name.split(' ')[0]), // Nombres m√°s cortos
                datasets: radarDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                elements: { line: { tension: 0.1, borderWidth: 2 } },
                scales: {
                    r: {
                        angleLines: { color: '#4f4f6f' },
                        grid: { color: '#4f4f6f' },
                        pointLabels: { font: { size: 9 }, color: '#dcdcdc' },
                        ticks: {
                            color: '#1e1e2f',
                            backdropColor: '#a0a0c0',
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { font: { size: 10 } }
                    }
                }
            }
        });

        // --- Gr√°ficos de Barras (existentes) ---
        const allSubSkillsData = Object.entries(skills)
            .flatMap(([skillName, skill]) => 
                Object.entries(skill.subSkills)
                    .filter(([, subSkill]) => subSkill.xp > 0)
                    .map(([subSkillName, subSkill]) => ({ name: subSkillName, xp: subSkill.xp, parent: skillName, category: skill.category }))
            );

        for (const [categoryId, category] of Object.entries(CATEGORIES)) {
            const subSkillsData = allSubSkillsData
                .filter(item => item.category === categoryId)
                .sort((a, b) => b.xp - a.xp)
                .slice(0, 15);
            
            if (subSkillsData.length === 0) continue;

            const categoryTitle = document.createElement('h3');
            categoryTitle.textContent = `Detalle: ${category.name}`;
            container.appendChild(categoryTitle);

            const chartWrapper = document.createElement('div');
            chartWrapper.className = 'chart-container';
            const canvas = document.createElement('canvas');
            chartWrapper.appendChild(canvas);
            container.appendChild(chartWrapper);

            const labels = subSkillsData.map(s => `${s.name} (${s.parent.split(' ')[0]})`);
            const data = subSkillsData.map(s => s.xp);

            chartInstances[`bar_${categoryId}`] = new Chart(canvas, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'XP Acumulada', data, backgroundColor: category.color }] },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#4f4f6f' }, ticks: { font: { size: 8 } } },
                        y: { grid: { color: '#4f4f6f' }, ticks: { font: { size: 8 } } }
                    }
                }
            });
        }
    }

    function updateDisplay() {
        skillsList.innerHTML = '';
        Object.entries(skills)
            .sort(([, a], [, b]) => b.xp - a.xp)
            .forEach(([skillName, skill]) => {
                const li = document.createElement('li');
                const progress = calculateSkillProgress(skill);
                
                li.innerHTML = `
                    <div class="skill-info-container">
                        <span class="skill-name"><span class="skill-icon">${skill.icon}</span>${skillName}</span>
                        <div class="skill-meta">Lvl: ${skill.level}<br>${skill.xp.toLocaleString()} XP</div>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fg" style="width: ${progress.progressPercentage}%;"></div>
                        <div class="progress-text">${Math.round(progress.progressPercentage)}%</div>
                    </div>
                `;
                skillsList.appendChild(li);
            });
    }

    function populateSkillSelect() {
        skillSelect.innerHTML = '';
        Object.keys(skills).sort().forEach(skillName => skillSelect.add(new Option(skillName, skillName)));
        populateSubSkillSelect(skillSelect.value);
    }

    function populateSubSkillSelect(skillName) {
        subSkillSelect.innerHTML = '';
        const subSkills = skills[skillName]?.subSkills;
        if (!subSkills || Object.keys(subSkills).length === 0) {
            subSkillSelect.disabled = true;
            subSkillSelect.add(new Option('A√±ade Habilidades Concretas', '', true, true));
        } else {
            Object.keys(subSkills).sort().forEach(subSkillName => subSkillSelect.add(new Option(subSkillName, subSkillName)));
            subSkillSelect.disabled = false;
        }
    }
    
    skillSelect.addEventListener('change', (e) => populateSubSkillSelect(e.target.value));

    function addLogEntry(message, type = '') {
        const logEntry = document.createElement('li');
        logEntry.innerHTML = message;
        if (type) logEntry.classList.add(type);
        logList.prepend(logEntry);
        while (logList.children.length > 30) logList.removeChild(logList.lastChild);
    }

    //================================================================================//
    //  SECCI√ìN 10: EVENTO PRINCIPAL Y MISIONES                                       //
    //================================================================================//
    
    function validateTemporalActivity() {
        const timeSpent = parseInt(timeInput.value);
        if (isNaN(timeSpent) || timeSpent <= 0) {
            throw new Error('Ingresa un tiempo v√°lido (m√≠nimo 1 minuto).');
        }
        return timeSpent;
    }

    function validateDiscreteActivity() {
        if (!unitCheck.checked) {
            throw new Error('Marca la actividad como completada.');
        }
        return true;
    }

    function calculateXpGained(activityType, timeSpent) {
        const intensity = intensitySelect.value;
        const performance = performanceSelect.value;
        let baseXp = activityType === 'temporal' 
            ? Math.floor((timeSpent / 15) * XP_PER_15_MINS)
            : XP_PER_UNIT;
        return Math.floor(baseXp * INTENSITY_MULTIPLIERS[intensity] * PERFORMANCE_MULTIPLIERS[performance]);
    }

    function createSessionEntry(activityType, timeSpent, xpGained) {
        return {
            date: new Date().toISOString(),
            type: activityType,
            time: activityType === 'temporal' ? timeSpent : null,
            intensity: intensitySelect.value,
            performance: performanceSelect.value,
            xpEarned: xpGained
        };
    }

    registerBtn.addEventListener('click', () => {
        try {
            const selectedSkill = skillSelect.value;
            const selectedSubSkill = subSkillSelect.value;
            const activityType = temporalBtn.classList.contains('active') ? 'temporal' : 'discrete';
            
            if (!selectedSkill || subSkillSelect.disabled || !selectedSubSkill) {
                throw new Error('Selecciona una habilidad v√°lida.');
            }
            
            const skillData = skills[selectedSkill];
            const subSkillData = skillData.subSkills[selectedSubSkill];
            const oldLevel = skillData.level;
            let timeSpent;

            if (activityType === 'temporal') {
                timeSpent = validateTemporalActivity();
            } else {
                validateDiscreteActivity();
            }
            
            const xpGained = calculateXpGained(activityType, timeSpent);
            
            subSkillData.xp += xpGained;
            skillData.xp += xpGained;
            
            subSkillData.sessions.push(createSessionEntry(activityType, timeSpent, xpGained));
            
            skillData.level = getLevelFromXp(skillData.xp);
            const leveledUp = skillData.level > oldLevel;
            
            const activityIcon = activityType === 'temporal' ? '‚è±Ô∏è' : '‚úÖ';
            const activityDetail = activityType === 'temporal' ? `${timeSpent} min` : 'Unidad completada';
            
            addLogEntry(`
                <div class="log-entry">
                    <span class="xp-gain">+${xpGained.toLocaleString()}</span>
                    <span class="skill-info">${skillData.icon} ${selectedSkill} (${selectedSubSkill})</span>
                    <span class="activity-details">${activityIcon} ${activityDetail}</span>
                    <div class="evaluation">
                        <span class="intensity ${intensitySelect.value}">Int: ${intensitySelect.value}</span>
                        <span class="performance ${performanceSelect.value}">Des: ${performanceSelect.value}</span>
                    </div>
                </div>`, 
                leveledUp ? 'level-up' : ''
            );
            
            if (leveledUp) {
                const progress = calculateSkillProgress(skillData);
                addLogEntry(`
                    <div class="level-up">
                        <span>üéâ ¬°Nivel ${skillData.level} en ${selectedSkill}!</span>
                        <div class="level-progress">Progreso: ${progress.progressPercentage.toFixed(1)}%</div>
                    </div>`, 
                    'level-up'
                );
            }
            
            timeInput.value = '';
            unitCheck.checked = false;
            intensitySelect.value = 'medio';
            performanceSelect.value = 'normal';
            
            updateAllUI();
            
        } catch (error) {
            addLogEntry(`<span class="error">‚úó ${error.message}</span>`);
            console.error('Error en registro:', error);
        }
    });

    createMissionBtn.addEventListener('click', () => {
        const title = missionTitleInput.value;
        const date = missionDateInput.value;
        const time = missionTimeInput.value;
        const description = missionDescriptionInput.value;

        if(!title || !date || !time) {
            addLogEntry('<span class="error">‚úó Por favor, completa t√≠tulo, fecha y hora de la misi√≥n.</span>');
            return;
        }

        const startDateTime = new Date(`${date}T${time}`);
        const endDateTime = new Date(startDateTime.getTime() + 60 * 60 * 1000); 

        const toGoogleFormat = (date) => date.toISOString().replace(/[-:.]/g, '').slice(0, 15);

        const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${toGoogleFormat(startDateTime)}/${toGoogleFormat(endDateTime)}&details=${encodeURIComponent(description)}&sf=true&output=xml`;

        window.open(googleCalendarUrl, '_blank');
        addLogEntry(`üóìÔ∏è Recordatorio para "${title}" enviado a Google Calendar.`);
    });

    //================================================================================//
    //  SECCI√ìN 11: INICIALIZACI√ìN PRINCIPAL DE LA APLICACI√ìN                         //
    //================================================================================//
    window.onload = () => { 
        resetLocalData();
        setupActivityTypeSwitcher();
    };
    </script>
    
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
