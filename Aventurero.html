<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Aventurero v9.3 (Edición y Mejoras)</title>
    <!-- Importación de la librería Chart.js para los gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ==========================================================================
           1. IMPORTACIÓN DE FUENTES E INICIALIZACIÓN
           ========================================================================== */
        
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        html {
            font-size: 100%; 
            scroll-behavior: smooth;
        }

        /* ==========================================================================
           2. ESTILOS GENERALES DEL CUERPO (BODY)
           ========================================================================== */
        
        body {
            background-color: #1e1e2f;
            color: #dcdcdc;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        /* ==========================================================================
           3. ESTRUCTURA Y LAYOUT PRINCIPAL
           ========================================================================== */

        .main-container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .sidebar {
            width: 280px;
            flex-shrink: 0;
            position: sticky;
            top: 20px;
        }

        .main-content {
            flex-grow: 1;
        }

        /* ==========================================================================
           4. ESTILOS DE LOS CONTENEDORES (PANELES)
           ========================================================================== */

        .container {
            border: 3px solid #4f4f6f;
            background-color: #2a2a40;
            padding: 20px;
            width: 100%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            border-radius: 8px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        /* ==========================================================================
           5. TIPOGRAFÍA (TÍTULOS Y TEXTOS)
           ========================================================================== */

        h1, h2 {
            color: #ffdd57;
            text-align: center;
            border-bottom: 2px solid #4f4f6f;
            padding-bottom: 10px;
            margin-top: 0;
            font-size: 1.5rem;
            text-shadow: 2px 2px #c23616;
        }

        h2 { font-size: 1.2rem; }
        h3 { font-size: 1rem; color: #4a90e2; margin-top: 20px; text-align: center; }
        h4 { font-size: 0.8rem; color: #a0a0c0; margin-bottom: 10px; border-top: 1px solid #4f4f6f; padding-top: 15px; margin-top: 15px;}

        label {
            display: block;
            margin-bottom: 8px;
            color: #a0a0c0;
            font-size: 0.8rem;
        }

        /* ==========================================================================
           6. ELEMENTOS DE FORMULARIO (INPUTS, SELECTS, BOTONES)
           ========================================================================== */

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background-color: #1e1e2f;
            color: #dcdcdc;
            border: 2px solid #4f4f6f;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        button, .nav-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            color: #FFFFFF;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-family: inherit;
            text-align: center;
            transition: all 0.1s ease-in-out;
            display: block;
            font-size: 0.8rem;
        }
        
        #register-btn { background: linear-gradient(145deg, #4a90e2, #3a7ac8); border-bottom: 4px solid #2a5a9a; }
        #auth-btn { background-color: #dd4b39; border-bottom: 4px solid #c23321;}
        .gdrive-btn { background-color: #4CAF50; border-bottom: 4px solid #388E3C; }
        .nav-btn { background-color: #6a4f9a; border-bottom: 4px solid #4a2f7a; }
        .nav-btn.active { background-color: #8a6fba; transform: translateY(2px); border-bottom-width: 2px;}
        button:disabled { background-color: #555; border-bottom-color: #444; color: #888; cursor: not-allowed; }

        /* ==========================================================================
           7. PANELES ESPECÍFICOS Y LISTAS
           ========================================================================== */
        
        .chart-container {
            position: relative;
            min-height: 150px;
            padding: 15px;
            background: #1e1e2f;
            border-radius: 5px;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        .skills-panel ul, .log-panel ul {
            list-style: none;
            padding: 0;
            max-height: 450px;
            overflow-y: auto;
        }
        
        .skills-panel li {
            background-color: #33334f;
            padding: 10px 15px;
            margin-bottom: 6px;
            border-left: 5px solid #ffdd57;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            border-radius: 4px;
        }
        
        .description-item {
            display: flex; flex-direction: column; align-items: flex-start; gap: 15px;
            background-color: #33334f; padding: 15px; margin-bottom: 10px;
            border-left: 5px solid #ffdd57; border-radius: 4px;
            font-size: 0.75rem; line-height: 1.5;
        }
        .description-header { display: flex; align-items: center; gap: 15px; width: 100%;}
        .description-img { width: 80px; height: 80px; border-radius: 4px; flex-shrink: 0; object-fit: cover; }
        
        .subskill-container { width: 100%; }
        .subskill-list { list-style: none; padding: 0; }
        .subskill-list li { 
            display: flex; 
            flex-direction: column;
            align-items: flex-start; 
            background-color: #2a2a40; 
            padding: 12px; 
            border-radius: 3px; 
            margin-bottom: 8px;
            font-size: 0.9rem;
            gap: 10px;
            border-left: 3px solid #6a4f9a;
        }
        .subskill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .subskill-actions {
            display: flex;
            gap: 5px;
        }
        .session-history {
            width: 100%;
            margin-top: 10px;
            border-top: 1px solid #4f4f6f;
            padding-top: 10px;
            font-size: 0.7rem;
            color: #a0a0c0;
        }
        .session-entry {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            padding: 4px;
            border-radius: 2px;
        }
        .session-entry:nth-child(odd) {
            background-color: #33334f;
        }
        .xp-earned {
            color: #32ff7e;
            font-weight: bold;
        }
        .subskill-input-group { display: flex; gap: 10px; }
        
        .edit-subskill-btn, .delete-subskill-btn { 
            border: none; color: white; padding: 5px 8px;
            border-radius: 3px; cursor: pointer; font-family: inherit; font-size: 0.8rem;
            width: auto;
            flex-shrink: 0;
        }
        .edit-subskill-btn { background: #4a90e2; }
        .delete-subskill-btn { background: #c23616; }
        
        .add-subskill-btn { flex-shrink: 0; width: auto; padding: 0 15px; font-size: 1.2rem; background-color: #4CAF50; border-bottom: 4px solid #388E3C; }
        
        .skill-icon { margin-right: 10px; }
        .log-panel ul { max-height: 200px; }
        
        .level-up { color: #32ff7e; font-weight: bold; text-align: center; font-size: 0.8rem !important; border-left-color: #32ff7e !important; }
        
        #gdrive-status { text-align: center; font-size: 0.7rem; padding: 10px; color: #a0a0c0; min-height: 20px; }
        
        .progress-bar-bg { background-color: #1e1e2f; border-radius: 5px; height: 10px; width: 100px; border: 1px solid #4f4f6f; }
        .progress-bar-fg { background-color: #32ff7e; height: 100%; border-radius: 5px; }
        
        .page-content { display: none; }
        .page-content.active { display: block; }
        
        #version-info {
            font-size: 0.65rem; color: #8a8a9e; text-align: right;
            margin-top: 15px; padding-top: 10px;
            border-top: 1px solid #4f4f6f; line-height: 1.4;
        }
        
        /* ==========================================================================
           8. DISEÑO RESPONSIVO (PARA MÓVILES)
           ========================================================================== */

        @media (max-width: 800px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100%; position: static; }
            .description-header { flex-direction: column; text-align: center; }
            html { font-size: 100%; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        
        <div class="sidebar">
            <div class="container">
                <h2>Navegación</h2>
                <button class="nav-btn active" data-page="dashboard">Panel de Control</button> 
                <button class="nav-btn" data-page="entrenamiento">Entrenamiento</button>
                <button class="nav-btn" data-page="misiones">Misiones</button>
                <button class="nav-btn" data-page="descripcion">Descripción</button>
            </div>
            
            <div class="container gdrive-section">
                <div id="gdrive-status">Inicia sesión para sincronizar.</div>
                <button id="auth-btn">Iniciar Sesión con Google</button>
                <button id="save-drive-btn" class="gdrive-btn" disabled>Guardar datos</button>
                <button id="load-drive-btn" class="gdrive-btn" disabled>Cargar el poder</button>
            </div>

             <div class="container log-panel">
                <h2>Registro</h2>
                <ul id="log-list"></ul>
                <div id="version-info">
                    v9.3 (Edición y Mejoras)
                </div>
            </div>
        </div>

        <div class="main-content">
            
            <div id="page-dashboard" class="page-content active">
                <div class="container">
                    <h1>Panel de Control</h1>
                    <div id="dashboard-charts-container">
                        <!-- Los gráficos por categoría se generarán aquí dinámicamente -->
                    </div>
                </div>
            </div>

            <div id="page-entrenamiento" class="page-content">
                <div class="container">
                    <h1>Panel de Aventurero</h1>
                    <div class="input-section">
                        <label for="skill-select">Habilidad General:</label>
                        <select id="skill-select"></select>
                        
                        <label for="subskill-select">Habilidad Concreta:</label>
                        <select id="subskill-select"></select>

                        <label for="time-input">Minutos de práctica:</label>
                        <input type="number" id="time-input" min="1" placeholder="Ej: 30">
                        
                        <label for="intensity-select">Intensidad:</label>
                        <select id="intensity-select">
                            <option value="bajo">Bajo (x0.8)</option>
                            <option value="medio" selected>Medio (x1.0)</option>
                            <option value="alto">Alto (x1.2)</option>
                        </select>
                        
                        <label for="performance-select">Desempeño:</label>
                        <select id="performance-select">
                            <option value="malo">Malo (x0.7)</option>
                            <option value="normal" selected>Normal (x1.0)</option>
                            <option value="bueno">Bueno (x1.3)</option>
                        </select>

                        <button id="register-btn">Registrar XP</button>
                    </div>
                </div>
                <div class="container skills-panel">
                    <h2>Habilidades</h2>
                    <ul id="skills-list"></ul>
                </div>
            </div>

            <div id="page-misiones" class="page-content">
                <div class="container">
                    <h1>Misiones</h1>
                    <p style="text-align:center;">¡Aquí podrás ver y gestionar tus misiones!</p>
                    <p style="text-align:center; color: #a0a0c0;">(Próximamente...)</p>
                </div>
            </div>

            <div id="page-descripcion" class="page-content">
                <div class="container description-content">
                    <!-- El contenido de esta sección se genera dinámicamente con JavaScript. -->
                </div>
            </div>
        </div>
    </div>

    <script>
    //================================================================================//
    //  SECCIÓN 1: CONFIGURACIÓN DE ACCESO A GOOGLE DRIVE API                         //
    //================================================================================//
    const CLIENT_ID = '432634777489-acq7bb59h2ggc223oafccitlvskvqh6p.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyB17ehizwOK9efPy7Bo7Zss2zveYSVhwE8';
    
    //================================================================================//
    //  SECCIÓN 2: ESTRUCTURA DE DATOS INICIAL                                        //
    //================================================================================//
    const initialSkills = {
        'Avance (Formación)': { xp: 0, level: 1, icon: '⚔️', subSkills: {}, img: 'https://placehold.co/80x80/c23616/FFFFFF?text=⚔️', category: 'combate', description: 'Todo lo que impulsa tu carrera. Estudiar, hacer networking, desarrollar un proyecto laboral, buscar un ascenso, trabajar en equipo, puntualidad.' },
        'Fuerza (Salud centrada en el cuerpo)': { xp: 0, level: 1, icon: '�', subSkills: {}, img: 'https://placehold.co/80x80/e84118/FFFFFF?text=💪', category: 'combate', description: 'Entrenamiento de fuerza, levantamiento de pesas, calistenia, funcional.' },
        'Defensa (Finanzas Personales)': { xp: 0, level: 1, icon: '🛡️', subSkills: {}, img: 'https://placehold.co/80x80/4cd137/FFFFFF?text=🛡️', category: 'combate', description: 'Ahorrar, invertir, crear un presupuesto, aprender sobre economía, pagar deudas.' },
        'Constitución (Salud y Resistencia)': { xp: 0, level: 1, icon: '❤️', subSkills: {}, img: 'https://placehold.co/80x80/ff4757/FFFFFF?text=❤️', category: 'combate', description: 'Dormir bien, mantenerse hidratado, procurar cumplir con los ciclos circadianos, chequeos médicos, baños de agua helada.' },
        'Agilidad (Salud centrada en cuerpo)': { xp: 0, level: 1, icon: '🏃', subSkills: {}, img: 'https://placehold.co/80x80/1e90ff/FFFFFF?text=🏃', category: 'combate', description: 'Actividades de Cardio y Flexibilidad como correr, nadar, yoga, ciclismo, estiramientos, gimnasia funcional.' },
        'Magia (Habilidades Sociales)': { xp: 0, level: 1, icon: '✨', subSkills: {}, img: 'https://placehold.co/80x80/8c7ae6/FFFFFF?text=✨', category: 'combate', description: 'Comunicación, oratoria, negociación, empatía, inteligencia emocional, psicoterapia, compañerismo' },
        'Espiritual (Salud Mental)': { xp: 0, level: 1, icon: '🧘', subSkills: {}, img: 'https://placehold.co/80x80/718093/FFFFFF?text=🧘', category: 'autocuidado', description: 'Meditar, Mindfulness, escribir un diario, practicar la gratitud, terapias, plegarias, amor, amistades' },
        'Nutrición (Salud corporal)': { xp: 0, level: 1, icon: '🌿', subSkills: {}, img: 'https://placehold.co/80x80/27ae60/FFFFFF?text=🌿', category: 'autocuidado', description: 'Aprender sobre macronutrientes, planificar comidas saludables, reducir procesados.' },
        'Cocina (Práctica)': { xp: 0, level: 1, icon: '🍳', subSkills: {}, img: 'https://placehold.co/80x80/fbc531/FFFFFF?text=🍳', category: 'autocuidado', description: 'Preparar tus propias comidas, aprender nuevas recetas, batch cooking.' },
        'Hobbies y Relajación (en la Nada y en el Todo a la vez)': { xp: 0, level: 1, icon: '🌌', subSkills: {}, img: 'https://placehold.co/80x80/3498db/FFFFFF?text=🌌', category: 'autocuidado', description: 'Dedicar tiempo a pasatiempos que te relajen y disfrutes sin un fin productivo. Leer ficción, tocar un instrumento, pintar, pescar.' },
        'Estudio Profundo': { xp: 0, level: 1, icon: '📚', subSkills: {}, img: 'https://placehold.co/80x80/9b59b6/FFFFFF?text=📚', category: 'artesania', description: 'Aprender una habilidad "dura" y compleja. Programación, un nuevo idioma, carpintería, edición de video.' },
        'Creación (Proyectos Creativos)': { xp: 0, level: 1, icon: '🎨', subSkills: {}, img: 'https://placehold.co/80x80/e74c3c/FFFFFF?text=🎨', category: 'artesania', description: 'Escribir, dibujar, componer música, crear contenido para tus seres queridos o las redes.' },
        'Construcción (Organización)': { xp: 0, level: 1, icon: '🏡', subSkills: {}, img: 'https://placehold.co/80x80/f39c12/FFFFFF?text=🏡', category: 'artesania', description: 'Ordenar tu casa, optimizar tu espacio de trabajo, bricolaje (DIY), minimalismo.'},
        'Grabación de Fuego (Disciplina)': { xp: 0, level: 1, icon: '🔥', subSkills: {}, img: 'https://placehold.co/80x80/d35400/FFFFFF?text=🔥', category: 'artesania', description: 'La habilidad "meta". Se enfoca en el acto de construir y mantener la rutina. La clave es la simplicidad y la consistencia.' }
    };
    
    const MIGRATION_MAP = {
        "Ataque (Carrera)": "Avance (Formación)", "Fuerza (Fitness)": "Fuerza (Salud centrada en el cuerpo)", "Agilidad (Cardio)": "Agilidad (Salud centrada en cuerpo)", "Oración (Mindfulness)": "Espiritual (Salud Mental)", "Herbología (Nutrición)": "Nutrición (Salud corporal)", "Pesca (Hobbies)": "Hobbies y Relajación", "Herrería (Estudio)": "Estudio Profundo", "Creación de Fuego (Disciplina y Hábitos)": "Grabación de Fuego (Disciplina)", "Hobbies y Relajación": "Hobbies y Relajación (en la Nada y en el Todo a la vez)"
    };

    let skills = {};
    let chartInstances = {};
    
    //================================================================================//
    //  SECCIÓN 3: CONSTANTES DE LÓGICA DE JUEGO                                      //
    //================================================================================//
    const XP_PER_15_MINS = 100;
    const INTENSITY_MULTIPLIERS = { bajo: 0.8, medio: 1.0, alto: 1.2 };
    const PERFORMANCE_MULTIPLIERS = { malo: 0.7, normal: 1.0, bueno: 1.3 };

    //================================================================================//
    //  SECCIÓN 4: REFERENCIAS A ELEMENTOS DEL HTML (DOM)                             //
    //================================================================================//
    const authBtn = document.getElementById('auth-btn');
    const saveBtn = document.getElementById('save-drive-btn');
    const loadBtn = document.getElementById('load-drive-btn');
    const statusDiv = document.getElementById('gdrive-status');
    const skillSelect = document.getElementById('skill-select');
    const subSkillSelect = document.getElementById('subskill-select');
    const timeInput = document.getElementById('time-input');
    const registerBtn = document.getElementById('register-btn');
    const skillsList = document.getElementById('skills-list');
    const logList = document.getElementById('log-list');
    const descriptionContainer = document.querySelector('#page-descripcion .description-content');
    const intensitySelect = document.getElementById('intensity-select');
    const performanceSelect = document.getElementById('performance-select');
    
    //================================================================================//
    //  SECCIÓN 5: LÓGICA DE NAVEGACIÓN (SPA)                                         //
    //================================================================================//
    const navButtons = document.querySelectorAll('.nav-btn');
    const pages = document.querySelectorAll('.page-content');
    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetPage = button.getAttribute('data-page');
            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            pages.forEach(page => page.classList.toggle('active', page.id === 'page-' + targetPage));
            if (targetPage === 'dashboard') {
                renderDashboardCharts();
            }
            if (window.matchMedia('(max-width: 800px)').matches) {
                document.getElementById('page-' + targetPage)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });

    //================================================================================//
    //  SECCIÓN 6: LÓGICA DE LA PÁGINA "DESCRIPCIÓN"                                  //
    //================================================================================//
    
    function renderDescriptionPage() {
        descriptionContainer.innerHTML = '<h1>Descripción de Habilidades</h1>';
        const categories = { combate: 'Habilidades de "Combate"', autocuidado: 'Habilidades de "Autocuidado"', artesania: 'Habilidades de "Artesanía"' };
        for (const categoryId in categories) {
            const categoryTitle = document.createElement('h3');
            categoryTitle.textContent = categories[categoryId];
            descriptionContainer.appendChild(categoryTitle);
            const categoryList = document.createElement('ul');
            categoryList.style.padding = '0';
            for (const skillName in skills) {
                if (skills[skillName].category === categoryId) {
                    const skill = skills[skillName];
                    const item = document.createElement('li');
                    item.className = 'description-item';
                    item.setAttribute('data-skill', skillName);
                    item.innerHTML = `<div class="description-header"><img src="${skill.img}" alt="Icono" class="description-img"><div><strong>${skillName}:</strong> ${skill.description}</div></div><div class="subskill-container"><h4>Habilidades Concretas:</h4><ul class="subskill-list"></ul><div class="subskill-input-group"><input type="text" placeholder="Añadir nueva habilidad..." maxlength="50"><button class="add-subskill-btn">+</button></div></div>`;
                    categoryList.appendChild(item);
                }
            }
            descriptionContainer.appendChild(categoryList);
        }
        renderAllSubSkillLists();
        addDescriptionPageListeners();
    }
    
    function renderSubSkillList(skillName) {
        const listElement = document.querySelector(`.description-item[data-skill="${skillName}"] .subskill-list`);
        if (!listElement) return;
        listElement.innerHTML = '';
        const skill = skills[skillName];
        if (skill && skill.subSkills) {
            Object.entries(skill.subSkills).forEach(([subSkillName, subSkillData]) => {
                const li = document.createElement('li');
                
                let sessionsHTML = '<div class="session-history"><h5>Historial Reciente:</h5>';
                if (subSkillData.sessions && subSkillData.sessions.length > 0) {
                     subSkillData.sessions.slice().reverse().slice(0, 5).forEach(session => {
                        const dateStr = new Date(session.date).toLocaleDateString();
                        sessionsHTML += `
                            <div class="session-entry">
                                <span>🗓️ ${dateStr} (${session.time} min)</span>
                                <span class="xp-earned">+${session.xpEarned} XP</span>
                            </div>`;
                     });
                } else {
                    sessionsHTML += '<span>No hay sesiones registradas.</span>';
                }
                sessionsHTML += '</div>';

                li.innerHTML = `
                    <div class="subskill-header">
                        <span>${subSkillName} (${subSkillData.xp.toLocaleString()} XP)</span> 
                        <div class="subskill-actions">
                            <button class="edit-subskill-btn" data-name="${subSkillName}" title="Editar nombre">✏️</button>
                            <button class="delete-subskill-btn" data-name="${subSkillName}" title="Eliminar">🗑️</button>
                        </div>
                    </div>
                    ${sessionsHTML}
                `;
                listElement.appendChild(li);
            });
        }
    }

    function renderAllSubSkillLists() {
        for (const skillName in skills) { renderSubSkillList(skillName); }
    }

    function addDescriptionPageListeners() {
        descriptionContainer.addEventListener('click', (e) => {
            const target = e.target.closest('button'); // Asegurarse de capturar el botón aunque se haga clic en el ícono
            if (!target) return;

            const parentItem = target.closest('.description-item');
            if (!parentItem) return;
            const skillName = parentItem.getAttribute('data-skill');
            const skillData = skills[skillName];

            if (target.classList.contains('add-subskill-btn')) {
                const input = parentItem.querySelector('input[type="text"]');
                const value = input.value.trim();
                if (value && !skillData.subSkills.hasOwnProperty(value) && Object.keys(skillData.subSkills).length < 25) {
                    skillData.subSkills[value] = { xp: 0, sessions: [] };
                    renderSubSkillList(skillName);
                    populateSubSkillSelect(skillSelect.value);
                    input.value = '';
                } else if(skillData.subSkills.hasOwnProperty(value)) {
                    addLogEntry('⚠️ Ya existe una habilidad con ese nombre.', 'level-up');
                }
            }
            
            if (target.classList.contains('edit-subskill-btn')) {
                const oldName = target.getAttribute('data-name');
                const newName = prompt('Ingresa el nuevo nombre para la habilidad:', oldName);

                if (newName && newName.trim() !== '' && newName !== oldName && !skillData.subSkills.hasOwnProperty(newName)) {
                    // Renombrar la clave del objeto sin perder los datos
                    Object.defineProperty(skillData.subSkills, newName,
                        Object.getOwnPropertyDescriptor(skillData.subSkills, oldName));
                    delete skillData.subSkills[oldName];
                    
                    renderSubSkillList(skillName);
                    populateSubSkillSelect(skillSelect.value);
                    addLogEntry(`✔️ "${oldName}" renombrada a "${newName}".`);
                } else if (newName && newName === oldName) {
                    // No hacer nada si el nombre es el mismo
                } else if (newName && skillData.subSkills.hasOwnProperty(newName)) {
                    addLogEntry('⚠️ Ya existe una habilidad con ese nombre.', 'level-up');
                }
            }

            if (target.classList.contains('delete-subskill-btn')) {
                const subSkillNameToDelete = target.getAttribute('data-name');
                // IMPORTANTE: Ya no se resta la XP de la habilidad padre al borrar una sub-habilidad.
                // El esfuerzo general en la categoría se conserva.
                delete skillData.subSkills[subSkillNameToDelete];
                
                renderSubSkillList(skillName);
                populateSubSkillSelect(skillSelect.value);
                // No es necesario actualizar el display general ni los gráficos, ya que el XP total no cambió.
                addLogEntry(`🗑️ Habilidad concreta "${subSkillNameToDelete}" eliminada.`);
            }
        });
    }

    //================================================================================//
    //  SECCIÓN 7: INICIALIZACIÓN DE LA API DE GOOGLE                                 //
    //================================================================================//
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const FILENAME = 'progreso_agenda_v3.json'; 
    const OLD_FILENAME_V2 = 'progreso_agenda_v2.json';
    const OLD_FILENAME_V1 = 'progreso_agenda.json';
    let tokenClient;
    let gapiInited = false, gisInited = false;
    
    function gapiLoaded() { gapi.load('client', initializeGapiClient); }
    async function initializeGapiClient() { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }); gapiInited = true; maybeEnableButtons(); }
    function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); gisInited = true; maybeEnableButtons(); }
    function maybeEnableButtons() { if (gapiInited && gisInited) { authBtn.style.display = 'block'; } }
    function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) { throw (resp); }
            authBtn.textContent = 'Refrescar Sesión';
            saveBtn.disabled = false; loadBtn.disabled = false;
            statusDiv.textContent = '¡Sesión iniciada! Listo para sincronizar.';
        };
        if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'});
        else tokenClient.requestAccessToken({prompt: ''});
    }
    authBtn.addEventListener('click', handleAuthClick);
    
    //================================================================================//
    //  SECCIÓN 8: FUNCIONES PRINCIPALES DE GOOGLE DRIVE                              //
    //================================================================================//
    
    async function findFileIdByName(name) {
        try {
            const response = await gapi.client.drive.files.list({ q: `name='${name}' and trashed=false`, fields: 'files(id, name)', spaces: 'drive' });
            return response.result.files.length > 0 ? response.result.files[0].id : null;
        } catch (err) {
            addLogEntry(`Error buscando archivo: ${err.message}`, 'level-up');
            return null;
        }
    }

    saveBtn.onclick = async () => {
        statusDiv.textContent = 'Guardando en Google Drive...';
        const fileId = await findFileIdByName(FILENAME);
        const fileContent = JSON.stringify(skills, null, 2);
        const boundary = '-------314159265358979323846';
        const delimiter = `\r\n--${boundary}\r\n`;
        const close_delim = `\r\n--${boundary}--`;
        let metadata = { mimeType: 'application/json' };
        let requestBody;
        if (fileId) {
            requestBody = `${delimiter}Content-Type: application/json\r\n\r\n${JSON.stringify(metadata)}${delimiter}Content-Type: application/json\r\n\r\n${fileContent}${close_delim}`;
            const request = gapi.client.request({ path: `/upload/drive/v3/files/${fileId}`, method: 'PATCH', params: { uploadType: 'multipart' }, headers: { 'Content-Type': `multipart/related; boundary="${boundary}"` }, body: requestBody });
            request.execute(() => { statusDiv.textContent = '¡Progreso guardado!'; addLogEntry('💾 Progreso guardado en la nube.'); });
        } else {
            metadata.name = FILENAME;
            requestBody = `${delimiter}Content-Type: application/json\r\n\r\n${JSON.stringify(metadata)}${delimiter}Content-Type: application/json\r\n\r\n${fileContent}${close_delim}`;
            const createRequest = gapi.client.request({ path: '/upload/drive/v3/files', method: 'POST', params: { uploadType: 'multipart' }, headers: { 'Content-Type': `multipart/related; boundary="${boundary}"` }, body: requestBody });
            createRequest.execute(() => { statusDiv.textContent = '¡Archivo creado y guardado!'; addLogEntry('💾 Archivo de progreso creado.'); });
        }
    };
    
    loadBtn.onclick = async () => {
        statusDiv.textContent = 'Buscando archivo en Google Drive...';
        
        let fileId = await findFileIdByName(FILENAME) || await findFileIdByName(OLD_FILENAME_V2) || await findFileIdByName(OLD_FILENAME_V1);

        if (!fileId) {
            statusDiv.textContent = 'No se encontró archivo de progreso.';
            addLogEntry('⚠️ No se encontró archivo.', 'level-up');
            return;
        }

        statusDiv.textContent = 'Cargando datos desde Google Drive...';
        try {
            const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
            const loadedSkills = JSON.parse(response.body);
            if (loadedSkills && typeof loadedSkills === 'object') {
                const hydratedSkills = JSON.parse(JSON.stringify(initialSkills));
                let migrationOccurred = false;

                for (const savedSkillName in loadedSkills) {
                    let targetSkillName = MIGRATION_MAP[savedSkillName] || savedSkillName;
                    if (hydratedSkills[targetSkillName]) {
                        const savedData = loadedSkills[savedSkillName];
                        
                        hydratedSkills[targetSkillName].xp = savedData.xp || 0;

                        const newSubSkills = {};
                        if (savedData.subSkills && typeof savedData.subSkills === 'object') {
                           if (Array.isArray(savedData.subSkills)) { 
                                migrationOccurred = true;
                                savedData.subSkills.forEach(name => {
                                    newSubSkills[name] = { xp: 0, sessions: [] };
                                });
                            } else { 
                                for (const subName in savedData.subSkills) {
                                    const subSkillData = savedData.subSkills[subName];
                                    newSubSkills[subName] = {
                                        xp: subSkillData.xp || 0,
                                        sessions: subSkillData.sessions || [] 
                                    };
                                }
                            }
                        }
                        hydratedSkills[targetSkillName].subSkills = newSubSkills;
                        hydratedSkills[targetSkillName].level = getLevelFromXp(hydratedSkills[targetSkillName].xp);
                    }
                }
                
                skills = hydratedSkills;
                updateDisplay(); 
                populateSelect(); 
                renderDescriptionPage(); 
                renderDashboardCharts();
                statusDiv.textContent = '¡Progreso cargado desde Drive!'; 
                addLogEntry('📂 Progreso cargado.');

                if (migrationOccurred) {
                    addLogEntry('✨ Datos antiguos migrados. Guarda para actualizar al nuevo formato.', 'level-up');
                }
            } else { throw new Error("Formato de datos inválido."); }
        } catch (err) { statusDiv.textContent = `Error: ${err.message}`; addLogEntry(`❌ Error: ${err.message}`, 'level-up'); }
    };

    //================================================================================//
    //  SECCIÓN 9: LÓGICA CENTRAL DE LA APLICACIÓN                                    //
    //================================================================================//
    
    function getLevelFromXp(xp) {
        let level = 1; 
        while (Math.pow(level, 2) * 1000 <= xp) { 
            level++; if (level > 200) return 200;
        }
        return level;
    }

    function renderDashboardCharts() {
        const container = document.getElementById('dashboard-charts-container');
        if (!container) return;
        container.innerHTML = '';
        Object.values(chartInstances).forEach(chart => chart.destroy());
        chartInstances = {};

        const categories = { combate: 'Habilidades de "Combate"', autocuidado: 'Habilidades de "Autocuidado"', artesania: 'Habilidades de "Artesanía"'};
        const categoryColors = { combate: '#e84118', autocuidado: '#4cd137', artesania: '#9b59b6'};

        for (const categoryId in categories) {
            let subSkillsData = [];
            for (const skillName in skills) {
                if (skills[skillName].category === categoryId) {
                    Object.entries(skills[skillName].subSkills).forEach(([subSkillName, subSkillDetails]) => {
                        if (subSkillDetails.xp > 0) {
                            subSkillsData.push({ name: subSkillName, xp: subSkillDetails.xp, parent: skillName });
                        }
                    });
                }
            }

            if (subSkillsData.length > 0) {
                subSkillsData.sort((a, b) => b.xp - a.xp);
                const categoryTitle = document.createElement('h3');
                categoryTitle.textContent = categories[categoryId];
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'chart-container';
                const canvas = document.createElement('canvas');
                chartWrapper.appendChild(canvas);
                container.appendChild(categoryTitle);
                container.appendChild(chartWrapper);

                const labels = subSkillsData.map(s => `${s.name} (${s.parent.split(' ')[0]})`);
                const data = subSkillsData.map(s => s.xp);

                Chart.defaults.font.family = "'Press Start 2P', cursive";
                Chart.defaults.color = '#dcdcdc';

                chartInstances[categoryId] = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'XP Acumulada', data, backgroundColor: categoryColors[categoryId] }] },
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { grid: { color: '#4f4f6f' }, ticks: { font: { size: 8 } } }, y: { grid: { color: '#4f4f6f' }, ticks: { font: { size: 8 } } } }
                    }
                });
            }
        }
    }

    function updateDisplay() {
        skillsList.innerHTML = ''; 
        const sortedSkills = Object.entries(skills).sort(([,a],[,b]) => b.xp - a.xp);
        for (const [skillName, skill] of sortedSkills) {
            const li = document.createElement('li'); 
            const xpForCurrentLevel = skill.level > 1 ? Math.pow(skill.level - 1, 2) * 1000 : 0;
            const xpForNextLevel = Math.pow(skill.level, 2) * 1000; 
            const xpInCurrentLevel = skill.xp - xpForCurrentLevel;
            const xpNeededForLevel = xpForNextLevel - xpForCurrentLevel; 
            const progressPercentage = xpNeededForLevel > 0 ? (xpInCurrentLevel / xpNeededForLevel) * 100 : 0;
            li.innerHTML = `<div style="flex-grow: 1;"><span><span class="skill-icon">${skill.icon}</span>${skillName}</span><div style="font-size: 0.8rem; color: #a0a0c0;">Lvl: ${skill.level} (${skill.xp.toLocaleString()} XP)</div></div><div class="progress-bar-bg"><div class="progress-bar-fg" style="width: ${progressPercentage}%;"></div></div>`;
            skillsList.appendChild(li);
        }
    }

    function populateSelect() {
        skillSelect.innerHTML = ''; 
        const skillNames = Object.keys(skills).sort();
        for (const skillName of skillNames) { 
            const option = document.createElement('option'); 
            option.value = skillName; 
            option.textContent = skillName; 
            skillSelect.appendChild(option); 
        }
        populateSubSkillSelect(skillSelect.value);
    }
    
    function populateSubSkillSelect(selectedSkill) {
        subSkillSelect.innerHTML = '';
        const subSkills = skills[selectedSkill]?.subSkills;
        if (subSkills && Object.keys(subSkills).length > 0) {
            Object.keys(subSkills).sort().forEach(subSkill => {
                const option = document.createElement('option');
                option.value = subSkill; option.textContent = subSkill;
                subSkillSelect.appendChild(option);
            });
            subSkillSelect.disabled = false;
        } else {
            const option = document.createElement('option');
            option.textContent = 'Añade Habilidades Concretas';
            option.disabled = true;
            subSkillSelect.appendChild(option);
            subSkillSelect.disabled = true;
        }
    }
    
    skillSelect.addEventListener('change', (e) => populateSubSkillSelect(e.target.value));

    function addLogEntry(message, type = '') {
        const logEntry = document.createElement('li'); 
        logEntry.innerHTML = message;
        if (type) logEntry.classList.add(type);
        logList.prepend(logEntry);
        if (logList.children.length > 20) logList.removeChild(logList.lastChild);
    }

    //================================================================================//
    //  SECCIÓN 10: EVENTO PRINCIPAL - REGISTRAR EXPERIENCIA (XP)                     //
    //================================================================================//
    registerBtn.addEventListener('click', () => {
        const selectedSkill = skillSelect.value;
        const selectedSubSkill = subSkillSelect.value;
        const timeSpent = parseInt(timeInput.value);
        const intensity = intensitySelect.value;
        const performance = performanceSelect.value;
        
        if (!selectedSkill || subSkillSelect.disabled || !selectedSubSkill || isNaN(timeSpent) || timeSpent <= 0) {
            addLogEntry('Entrada inválida.', 'level-up');
            return;
        }
        
        let xpGained = Math.floor((timeSpent / 15) * XP_PER_15_MINS);
        
        const intensityMultiplier = INTENSITY_MULTIPLIERS[intensity];
        const performanceMultiplier = PERFORMANCE_MULTIPLIERS[performance];
        xpGained = Math.floor(xpGained * intensityMultiplier * performanceMultiplier);
        
        const skillData = skills[selectedSkill];
        const subSkillData = skillData.subSkills[selectedSubSkill];
        const oldLevel = skillData.level;

        subSkillData.xp += xpGained;
        skillData.xp += xpGained;
        
        subSkillData.sessions.push({
            date: new Date().toISOString(),
            time: timeSpent,
            intensity: intensity,
            performance: performance,
            xpEarned: xpGained
        });
        
        skillData.level = getLevelFromXp(skillData.xp);
        
        addLogEntry(
            `+${xpGained.toLocaleString()} XP en ${skillData.icon} ${selectedSkill} (${selectedSubSkill}) ` +
            `por ${timeSpent} min. <br><small>Int: ${intensity} | Des: ${performance}</small>`
        );
        
        if (skillData.level > oldLevel) {
            addLogEntry(`¡Nivel ${skillData.level} en ${selectedSkill}!`, 'level-up');
        }
        
        timeInput.value = '';
        intensitySelect.value = 'medio';
        performanceSelect.value = 'normal';
        
        updateDisplay();
        renderDashboardCharts();
        renderSubSkillList(selectedSkill);
    });
    
    //================================================================================//
    //  SECCIÓN 11: INICIALIZACIÓN PRINCIPAL DE LA APLICACIÓN                         //
    //================================================================================//
    window.onload = () => { 
        skills = JSON.parse(JSON.stringify(initialSkills));
        populateSelect();
        updateDisplay(); 
        renderDescriptionPage();
        renderDashboardCharts();
        addLogEntry('¡Bienvenido, aventurero!'); 
    };
    </script>
    
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
�
